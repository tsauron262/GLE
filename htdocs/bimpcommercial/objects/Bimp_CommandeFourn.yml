extends: 
    module: bimpcommercial
    object_name: BimpComm

abstract: 0

dol_object: 
    instance: 
        dol_object: 
            module: fourn
            file: fournisseur.commande
            class: CommandeFournisseur
            
table: commande_fournisseur
controller: commandeFourn
icon: fas_cart-arrow-down

list_page_url: 
    controller: commandesFourn

labels: 
    name: commande fournisseur
    name_plur: commandes fournisseurs
    is_female: 1
        
objects: 
    lines: 
        instance: 
            bimp_object: Bimp_CommandeFournLine
            
    fournisseur: 
        relation: hasOne
        delete: 0
        instance: 
            bimp_object: 
                module: bimpcore
                name: Bimp_Fournisseur
            id_object: 
                field_value: fk_soc
            
    receptions: 
        relation: hasMany
        delete: 1
        instance: 
            bimp_object: 
                module: bimplogistique
                name: BL_CommandeFournReception
                
    files:
        list: 
            filters:
                parent_object_name: Bimp_CommandeFourn
        add_form: 
            values:
                fields: 
                    parent_object_name: Bimp_CommandeFourn
               
    user: 
        relation: hasOne
        delete: 0
        instance: 
            bimp_object: 
                module: bimpcore
                name: Bimp_User
            
    user_approve:
        extends: user
        instance: 
            id_object: 
                field_value: fk_user_approve
            
    user_approve2:
        extends: user
        instance: 
            id_object: 
                field_value: fk_user_approve2
            
    user_resp:
       extends: user
       instance: 
           id_object: 
              field_value: fk_user_resp
                
    equipment:
        instance:
            module: bimpequipment
            name: Equipment
      
associations: 
    factures: 
        object: facture_fourn
        label: Factures
        display: 
            default: 
                type: nom_url
    achatsCommFourn_Equipments:
        object: equipment
        label: Equipements concerné
        input:
            type: search_object
            object: equipment
                
fields: 
    fk_soc: 
        label: Fournisseur
        object: fournisseur
        input: 
            societe_type: supplier
            create_form: fournisseur_light
    ref_supplier: 
        label: Référence fournisseur
    model_pdf: 
        default_value: bimpcommandefourn
    total_ttc: 
        label: Total TTC
        type: money
    remise_percent: 
        label: Remise
        type: percent
        default_value: 0
    date_creation: 
        label: Créée le
        dol_prop: date
        type: datetime
    date_valid: 
        label: Validée le
        type: datetime
    date_approve: 
        label: 1ère approbation le
        type: datetime
    date_approve2: 
        label: 2ème approbation le
        type: datetime
    date_commande: 
        label: Date de la commande
        type: date
        input: 
            display_now: 1
    date_livraison: 
        label: Date prévue de livraison
        type: date
    fk_user_approve: 
        label: Approuvée par
        dol_prop: user_approve_id
        type: id_object
        object: user_approve
        input: 
            type: hidden
    fk_user_approve2: 
        label: Approuvée (2) par
        dol_prop: user_approve_id2
        type: id_object
        object: user_approve2
        input: 
            type: hidden
    fk_user_resp: 
        label: Personne en charge
        type: id_object
        object: user_resp
        default_value: 
            prop:
                name: id
                object: 
                    global: user
        input: 
            type: search_user
    fk_input_method: 
        label: Méthode de commande
        dol_prop: methode_commande_id
        type: int
        values: 
            array: commandeMethods
    fk_cond_reglement:
        required: 0
    fk_mode_reglement: 
        required: 0
    attente_info: 
        label: En attente d'infos
        type: bool
        default_value: 0         
    invoice_status: 
        label: Statut facturation
        type: int
        values: 
            array: invoice_status
    billed: 
        label: Facturé
        type: bool
        default_value: 0
    status_forced: 
        label: Status forcés
        type: json
    delivery_type: 
        label: Addresse de livraison
        type: int
        values: 
            array: delivery_types
        default_value: 0
    custom_delivery: 
        label: Adresse de livraison personnalisée
        type: text
        input: 
            auto_expand: 1
            rows: 3
            help: Contact (nom)<br/>Adresse<br/>Info Optionelle 1 (peut être invisible chez certains transporteurs)<br/>Info Optionelle 2 (peut être invisible chez certains transporteurs)<br/>CodeP Ville<br/>Pays (optionnel si France)
        display_if: 
            field_name: delivery_type
            show_values: 2
    edi_status:
        label: Statut chez le fournisseur
        type: int
        values: 
            array: edi_status
        default_value: 0
        display_if: 
            field_name: fk_input_method
            show_values: 7
#    type_entrepot:
#        label: Type entrepôt
#        type: int
#        values: 
#            array: typesEntrepot
#        default_value: 2
        
    ref_client: unset
    total: unset
    fk_availability: unset
    fk_input_reason: unset
    replaced_ref: unset
    
forms: 
    default: 
        rows: 
            - field: ref
            - field: entrepot
#            - field: type_entrepot
            - field: libelle
            - field: ef_type
            - field: fk_soc
            - field: fk_user_resp
            - field: ref_supplier
            - field: delivery_type
            - field: custom_delivery
            - field: date_livraison
            - field: fk_cond_reglement
            - field: fk_mode_reglement
            - field: model_pdf
            - field: zone_vente
              show: 
                  callback: isLoaded
            - field: attente_info
            - field: note_private
            - field: note_public
            - association: achatsCommFourn_Equipments
              edit: 1
              show:
                  conf: useLinkAchatFournEquipment
            
    make_order: 
        rows: 
            - field: date_commande
            - field: fk_input_method
            
    receive: 
        rows: 
            - custom: 1
              label: Date de livraison
              input_name: date_livraison
              data_type: date
              input: 
                  type: date
                  display_now: 1
            - custom: 1
              label: Livraison
              input_name: livraison_type
              input: 
                  type: select
                  options: 
                      array: livraison_types
            - custom: 1
              label: Commentaires
              data_type: string
              input_name: comments
              input: 
                  type: text
                  
    duplicate_commande_fourn: 
        title: Cloner
        force_edit: 1
        rows: 
            - field: libelle
            - field: entrepot
            - field: ef_type
            - field: fk_soc
            - field: ref_supplier
            - field: delivery_type
            - field: custom_delivery
            - field: date_livraison
            - field: fk_cond_reglement
            - field: fk_mode_reglement
            
    force_status: 
        title: Forcer un statut
        msgs: 
            - content: Lorqu&apos;un statut est forcé, il cesse d&apos;être déterminé automatiquement<br/>Pour annuler un forçage, sélectionnez "Aucun forçage"
              type: info
        rows: 
            - custom: 1
              label: Forcer le statut réception à
              input_name: reception_status
              input: 
                  type: select
                  options:
                      -1: Aucun forçage
                      3: En attente de réception
                      4: Reçue partiellement
                      5: Reçue entièrement
            - custom: 1
              label: Forcer le statut facturation à
              input_name: invoice_status
              input: 
                  type: select
                  options:
                      -1: Aucun forçage
                      0: Non facturée
                      1: Facturée partiellement
                      2: Facturée
                      
    invoice: 
        title: Facturation de réceptions
        icon: fas_file-invoice-dollar
        rows: 
            replaced_ref: 
                custom: 1
                label: Ref facture remplacée
                input_name: replaced_ref
                input: 
                    type: text
                    help: Utiliser ce champ si perte des données de la facture remplacée
            receptions: 
                custom: 1
                label: Réceptions de la commande à facturer
                input_name: receptions
                data_type: id
                input: 
                    type: check_list
                    items: 
                        array: factureReceptions
            add_origin_line: 
                custom: 1
                label: Inclure des lignes de texte indiquant la ou les commandes fournisseur d'origine
                input_name: add_origin_line
                data_type: bool
                input: 
                    type: toggle
                value: 1
            id_facture: 
                custom: 1
                label: Facture fournisseur
                data_type: id
                input_name: id_facture
                input: 
                   type: select
                   options: 
                       array: facturesFournisseur
                   help: Liste des factures fournisseur brouillon pour ce fournisseur et ce secteur.
            id_entrepot: 
                custom: 1
                show: 0
                label: Entrepôt
                input_name: id_entrepot
                input: 
                    type: search_entrepot
                display_if: 
                    field_name: id_facture
                    show_values: 0
            libelle: 
                custom: 1
                label: Libelle
                input_name: libelle
                input: 
                    type: text
                display_if: 
                    field_name: id_facture
                    show_values: 0
            ef_type: 
                custom: 1
                show: 0
                label: Secteur
                input_name: ef_type
                input: 
                    type: select
                    options: 
                        array: secteurs
                display_if: 
                    field_name: id_facture
                    show_values: 0
            ref_supplier:
                custom: 1
                label: Référence fournisseur
                required: 1
                input_name: ref_supplier
                data_type: string
                input: 
                    type: text
                display_if: 
                    field_name: id_facture
                    show_values: 0
            datef: 
                custom: 1
                label: Date facture
                data_type: date
                input_name: datef
                input: 
                    type: date
                    display_now: 1
                display_if: 
                    field_name: id_facture
                    show_values: 0
#            date_lim_reglement: 
#                custom: 1
#                label: Date d'échéance
#                data_type: date
#                input_name: date_lim_reglement
#                required: 1
#                input: 
#                    type: date
#                display_if: 
#                    field_name: id_facture
#                    show_values: 0
            cond_reglement: 
                custom: 1
                label: Conditions de réglement
                input_name: id_cond_reglement
                data_type: id
                input: 
                    type: select_cond_reglement
                display_if: 
                    field_name: id_facture
                    show_values: 0
                value: 
                    callback: getCondReglementBySociete
            mode_reglement: 
                custom: 1
                label: Mode de réglement
                input_name: id_mode_reglement
                data_type: id
                input: 
                    type: select_payment
                display_if: 
                    field_name: id_facture
                    show_values: 0
                value: 
                    callback: getModeReglementBySociete
            note_publique: 
                custom: 1
                label: Note publique
                input_name: note_public
                data_type: text
                input: 
                    type: textarea
                    rows: 3
                    auto_expand: 1
                display_if: 
                    field_name: id_facture
                    show_values: 0
            note_privee: 
                custom: 1
                label: Note privée
                input_name: note_private
                data_type: text
                input: 
                    type: textarea
                    rows: 3
                    auto_expand: 1
                display_if: 
                    field_name: id_facture
                    show_values: 0
                  
    bulk_invoice: 
        extends: invoice
        title: Nouvelle facture fournisseur
        rows: 
            receptions: 
                label: Réceptions à facturer
                input: 
                    items: 
                        array: postReceptions
                    help: Attention, toutes les réceptions doivent être du même fournisseur
                value: 
                    request_field: receptions                    
            id_facture: 
                hidden: 1
                input: 
                    type: hidden
                value: 0
            id_entrepot: 
                show: 1
            ef_type: 
                show: 1
         
fields_tables: 
    infos: 
        rows:         
            - field: entrepot
              display: nom_url
              edit: 1
#            - field: type_entrepot
#              edit: 1
            - field: ef_type    
            - field: fk_statut
            - field: invoice_status
            - field: attente_info
              edit: 1
            - field: date_commande
            - field: date_livraison
              edit: 1
            - field: delivery_type
              edit: 1
            - field: custom_delivery
              edit: 1
            - field: fk_input_method
              show: 
                  field_value: fk_input_method
            - field: entrepot
              display: nom_url
            - field: zone_vente
              edit: 1
            - field: edi_status
            - association: achatsCommFourn_Equipments
              edit: 1
              show:
                  conf: useLinkAchatFournEquipment
    
    fournisseur: 
        title: Fournisseur
        icon: fas_building
        rows: 
            - field: fk_soc
              display: card
            - field: ref_supplier
              edit: 1
                  
    payment:
        rows:
            - field: fk_cond_reglement
              edit: 
                  callback: isEditable
            - field: fk_mode_reglement
              edit: 
                  callback: isEditable
                
    pdf: 
        rows: 
            - label: Fichier PDF
              value: 
                  callback: displayPDFButton
                  
    totals: 
        rows: 
            - label: Remises
              value: 
                  callback: displayTotalRemises
            - field: total_ht
            - field: tva
            - field: total_ttc
            
views: 
    default: 
        objects_change_reload: Bimp_CommandeFournLine,ObjectLineRemise,BimpFile
        rows: 
            0: 
                cols: 
                    1:
                        rows: 
                            0: 
                                cols: 
                                    0: 
                                        fields_table: 
                                            name: fournisseur
    content: 
        rows: 
            0: 
                cols: 
                    1: unset
    
    content_infos: 
        objects_change_reload: Bimp_CommandeFournLine,ObjectLineRemise,BimpFile
    full: 
        objects_change_reload: Bimp_CommandeFournLine,ObjectLineRemise,BimpFile                 
    
filters_panels: 
    default: 
        filters: 
            type: unset
            total: unset
            ref_client: unset
            client:status: unset
            datec: unset
            
            date_creation: 
            ref_supplier: 
            date_commande: 
            date_livraison: 
            fk_user_resp: 
            
lists_cols: 
    invoice_status:
        label: St. Fac
        display: icon
        min_width: 30;
    billed: 
        label: Facturée
        type: bool
        default_value: 0
        input: 
            type: hidden
        
    total_pa: unset
    client_facturation: unset
    tx_marge: unset
    tx_marque: unset
    
lists: 
    default: 
        title: Commandes fournisseurs
        icon: fas_cart-arrow-down
        bulk_actions:
            delete: 
                label: supprimer les commandes fournisseurs sélectionnées
        sort_field: date_creation
        sort_way: desc
        cols: 
            ref: 
            fk_statut: 
            attente_info:
            date_creation:
            fk_user_resp:
            fk_soc: 
            total_ttc:
                
    fourn:
        extends: default
        cols: 
            fk_soc: unset
                
cards:
    default: 
        title: nom
        status: fk_statut
        fields: 
            - label: Fournisseur
              field: fk_soc
              display: nom_url
            - label: Entrepôt
              field: entrepot
              display: nom_url
        view_btn: 1

searches:
    default: 
        fields_search: 
            - a.ref
            - ef.libelle
            - s.nom
            - a.ref_supplier
        joins:
            ef: 
                table: commande_fournisseur_extrafields
                on: a.rowid = ef.fk_object
                alias: ef
            s: 
                table: societe
                on: a.fk_soc = s.rowid
                alias: s
        fields_return: 
            - a.ref
            - s.nom
        label_syntaxe: '<a.ref> (Fourn: <s.nom>)'
