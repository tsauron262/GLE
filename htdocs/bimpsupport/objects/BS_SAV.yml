table: bs_sav
controller: sav
icon: fas_wrench
public_icon: pe_tools

list_page_url: 
    controller: index
    url_params: 
        tab: sav
        id_entrepot: 
            field_value: id_entrepot
            
header_list_name: default
header_edit_form: edit

public_header_edit_form: public_edit

header_btn: 
    callback: getViewExtraBtn
        
nom_url: 
    with_status: 1
    syntaxe: <ref>
    card: default
    
labels:
    name: sav
    name_plur: sav

objects:
    contrat:
        card: 
            title: 
                object_prop: ref
            view_btn: 1
                
    user_tech: 
        extends: user
        instance: 
            id_object: 
                field_value: id_user_tech
        
    notes:
        instance:
            bimp_object: 
                module: bimpsupport
                name: BS_Note
        list: 
            filters: unset
                
    propal: 
        instance: 
            bimp_object: 
                module: bimpsupport
                name: BS_SavPropal
            id_object: 
                field_value: id_propal
                
    facture_acompte: 
        extends: facture
        instance: 
            id_object: 
                field_value: id_facture_acompte
                
    facture_avoir: 
        extends: facture
        instance: 
            id_object: 
                field_value: id_facture_avoir
                
    propal_lines: 
        relation: hasMany
        delete: 0
        instance: 
            bimp_object: BS_SavPropalLine
        list: 
            filters: 
                id_obj: 
                    field_value: id_propal
                    
    apple_parts: 
        relation: hasMany
        delete: 0
        instance: 
            bimp_object: BS_ApplePart       
            
    prets: 
        relation: hasMany
        delete: 1
        instance: 
            bimp_object: BS_Pret
            
    issues: 
        relation: hasMany
        delete: 1
        instance: 
            bimp_object: BS_Issue
            
    ticket: 
        relation: hasOne
        instance: 
            bimp_object: 
                module: bimpsupport
                name: BS_Ticket
            id_object: 
                field_value: id_ticket
            
    user_client: 
        relation: hasOne
        delete: 0
        instance: 
            bimp_object: 
                module: bimpinterfaceclient
                name: BIC_UserClient
            id_object: 
                field_value: id_user_client
                
associations: 
    propales:
        object: propal
        label: Devis
        
fields:
    ref:
        label: Référence
        required: 0
        search:
            input: 
                type: text
            type: value_part
            search_on_key_up: 1
        input: 
            type: hidden
    status: 
        label: Statut
        type: int
        values: 
            array: status_list
        default_value: 0
        displays: 
            actions: 
                type: callback
                method: displayStatusWithActions
    code_centre: 
        label: Centre de prise en charge
        values: 
            array: centres
        input: 
            options: 
                array: userCentres
        required: 1
        default_value: 
            callback: getDefaultCodeCentre
    code_centre_repa: 
        label: Centre de réparation
        values: 
            array: centres
        input: 
            help: Laisser vide si identique au centre de prise en charge
            options: 
                array: userCentres
    id_equipment: 
        label: Equipement
        type: id_object
        object: equipment
        required: 1
        input: 
            card: default
        create_form: light
        edit_form: light
        displays: 
            custom: 
                label: Affichage étendu
                type: callback
                method: displayEquipment
    id_ticket:
        label: Ticket Hotline
        type: id_object
        object: ticket        
    id_entrepot:
        label: Entrepot (stock)
        type: id_object
        object: bimp_entrepot
        input: 
            type: search_entrepot    
        default_value: 
            request: id_entrepot
    id_user_tech: 
        label: Technicien
        type: id_object
        object: user_tech
        input: 
            type: search_user
        search:
            input: 
                type: search_user
    id_client:
        label: Client
        type: id_object
        object: client
        required: 1
        input: 
            card: default
        search:
            input: 
                type: search_societe
                societe_type: customer    
        create_form: light
        edit_form: default
    id_contact:
        label: Contact
        type: id_object
        object: contact
        values: 
            array: client_contacts
        depends_on: id_client
        display_if:
            field_name: id_client
            hide_values: 0,
        search:
            input:
                type: search_list
                search_list:
                    table: socpeople
                    field_return_value: rowid
                    field_return_label: lastname,firstname
                    fields_search: lastname,firstname
                    label_syntaxe: <label_1> <label_2>    
        create_form: default
        edit_form: default
        create_form_values:
            fields: 
                fk_soc: 
                    field_value: id_client
    id_user_client: 
        label: Utilisateur client
        type: id_object
        object: user_client
    id_contrat:
        label: Contrat
        type: id_object
        object: contrat
        values: 
            array: contrats
        depends_on: id_client
        display_if: 
            field_name: id_client
            hide_values: 0,
    id_propal: 
        label: Devis
        type: id_object
        object: propal
        values: 
            array: propals
        displays: 
            default: 
                type: callback
                method: displayPropal
        display_if: 
            field_name: id_client
            hide_values: 0,
        depends_on: id_client
    id_facture_acompte:
        label: Facture d'acompte
        type: id_object
        object: facture_acompte
    id_facture_avoir:
        label: Facture d'avoir
        type: id_object
        object: facture_avoir
    id_discount:
        label: Réduction
        type: id
    id_facture: 
        label: Facture
        type: id_object
        object: facture
    date_close: 
        label: Date / Heure Fin
        type: datetime
    prestataire_number: 
        label: N° de dossier prestataire
        user_edit: 1
    sav_pro: 
        label: SAV Pro
        type: bool
        default_value: 0
        user_edit: 1
    accident: 
        label: Accident
        type: bool
        default_value: 0
    prioritaire: 
        label: Prioritaire
        type: bool
        default_value: 0
    save_option: 
        label: Sauvegarde
        type: int
        values: 
            array: save_options
        user_edit: 1
    contact_pref: 
        label: Préférence de contact retour
        type: int
        values: 
            array: contact_prefs
        user_edit: 1
    etat_materiel: 
        label: Etat matériel
        type: int
        values: 
            array: etats_materiel
        user_edit: 1
    etat_materiel_desc: 
        label: Description état matériel
        type: text
        input:
            auto_expand: 1
            rows: 1
            values: 
                array: list_etats_materiel
        user_edit: 1
    accessoires: 
        label: Accessoires
        type: text
        input:
            auto_expand: 1
            rows: 2
            values: 
                array: list_accessoires
        user_edit: 1
    symptomes: 
        label: Symptômes
        type: text
        input:
            auto_expand: 1
            rows: 4
            values: 
                array: list_symptomes
        required: 1
        user_edit: 1
    diagnostic: 
        label: Diagnostic
        type: text
        input:
            auto_expand: 1
            rows: 4
        user_edit: 1
    resolution: 
        label: Résolution
        type: text
        input:
            auto_expand: 1
            rows: 4
        user_edit: 1
    extra_infos:
        label: Informations supplémentaires devis
        type: text
        input:
            auto_expand: 1
            rows: 4
        user_edit: 1
    system: 
        label: Système
        type: int
        values: 
            array: systems
        user_edit: 1
    login_admin: 
        label: Login admin
        user_edit: 1
    pword_admin: 
        label: Mot de passe admin
        required: 1
        user_edit: 1
    acompte: 
        label: Acompte
        type: money
        default_value: 0
    version:
        label: Version
        type: float
        input: 
            type: hidden
        default_value: 0
    date_terminer:
        label: Date fin
        type: datetime
    replaced_ref: 
        label: Référence remplacée
        input: 
            help: Utiliser ce champ si perte des données de la pièce remplacée
    resgsx: 
        label: ID réservation GSX
    date_rdv: 
        label: Date de rendez-vous
        type: datetime
        displays: 
            default: 
                type: datetime
                show_hour: 1
        
forms: 
    default:
        rows: 
            - field: replaced_ref
            - field: code_centre
            - field: code_centre_repa
            - field: id_client
            - field: id_contact
            - field: id_equipment
            - custom: 1
              label: Conserver l'équipement dans son emplacement actuel
              input_name: keep_equipment_current_place
              data_type: bool
              content: 
                  callback: renderEquipmentPlaceOptionInput
              display_if: 
                  field_name: id_equipment
                  hide_values: 0,
              depends_on: id_equipment
            - field: symptomes
            - field: id_contrat
            - field: prioritaire
            - field: acompte
            - label: Mode de paiement de l'acompte
              custom: 1
              data_type: int
              input_name: mode_paiement_acompte
              input: 
                  type: select_payment
                  include_empty: 1
              display_if: 
                  field_name: acompte
                  hide_values: 0,
              value: 6
            - field: system
            - field: login_admin
            - field: pword_admin
            - field: contact_pref
            - field: accessoires
            - field: etat_materiel
            - field: etat_materiel_desc
            - field: save_option
            - field: sav_pro
            - field: prestataire_number
            - custom: 1
              label: Notifier le client de la création du SAV
              input_name: send_msg
              data_type: bool
              input: 
                  type: toggle
              value: 1
            - field: id_ticket
              hidden: 1
              
    prise_en_charge: 
        rows: 
            - field: code_centre
              edit: 0
            - field: code_centre_repa
            - field: id_client
            - field: id_contact
            - field: id_equipment
            - custom: 1
              label: Conserver l'équipement dans son emplacement actuel
              input_name: keep_equipment_current_place
              data_type: bool
              content: 
                  callback: renderEquipmentPlaceOptionInput
              display_if: 
                  field_name: id_equipment
                  hide_values: 0,
              depends_on: id_equipment
            - field: symptomes
            - field: id_contrat
            - field: prioritaire
            - field: acompte
            - label: Mode de paiement de l'acompte
              custom: 1
              data_type: int
              input_name: mode_paiement_acompte
              input: 
                  type: select_payment
                  include_empty: 1
              display_if: 
                  field_name: acompte
                  hide_values: 0,
              value: 6
            - field: system
            - field: login_admin
            - field: pword_admin
            - field: contact_pref
            - field: accessoires
            - field: etat_materiel
            - field: etat_materiel_desc
            - field: save_option
            - field: sav_pro
            - field: prestataire_number
              
    edit: 
        rows: 
            - field: replaced_ref
            - field: code_centre
            - field: code_centre_repa
            - field: id_client
            - field: id_contact
            - field: id_equipment
            - field: prioritaire
            - field: id_contrat
            - field: prestataire_number
#            - field: id_propal
            - field: id_user_tech
            - field: system
            - field: login_admin
            - field: pword_admin
            
    public_edit: 
        rows: 
            - field: system
            - field: contact_pref
            - field: etat_materiel
            - field: symptomes
#            - object: client
#              on_edit: 1
#              form_name: public
#            - object: contact
#              on_edit: 1
#              form_name: public_edit
            
            
    send_msg: 
        title: Envoi de notification
        rows: 
            - custom: 1
              label: Notifier le client
              input_name: send_msg
              data_type: bool
              input: 
                  type: toggle
              value: 1
        
    restitute:
        title: Restituer
        rows: 
            - custom: 1
              label: Mode de paiement
              input_name: mode_paiement
              input: 
                  type: select_payment
                  include_empty: 1
              value: 6
            - custom: 1
              label: Montant payé
              input_name: paid
              data_type: money
              input: 
                  type: text
              value: 
                  callback: getFactureAmountToPay
            - custom: 1
              label: Notifier le client
              input_name: send_msg
              data_type: bool
              input: 
                  type: toggle
              value: 1
            - custom: 1
              label: Replacer l'équipement dans son emplacement précédent
              input_name: put_equipment_on_prev_place
              data_type: bool
              content: 
                  callback: renderEquipmentPlaceOptionInput
                  
    close_refused: 
        title: Fermeture
        rows: 
            - custom: 1
              label: Frais de gestion
              input_name: frais
              data_type: money
              input: 
                  type: text
              value:
                  request: frais
            - custom: 1
              label: Dispo sous
              input_name: nbJours
              data_type: int
              min: 0
              value: 0
              input: 
                  addon_right: 
                      text: jour(s)
            - custom: 1
              label: Notifier le client
              input_name: send_msg
              data_type: bool
              input: 
                  type: toggle
              value: 0
              
    contact: 
        title: Recontacter
        rows: 
            - custom: 1
              label: Notification
              input_name: msg_type
              input: 
                  type: select
                  options: 
                      Facture: Facture
                      Devis: Devis
                      debut: PC
                      debDiago: Diagnostic
                      commOk: Pièce commandée
                      repOk: Réparation terminée
                      revPropRefu: Devis refusé
                      pieceOk: Piéce reçue
                      localise: Localisé
                      
    validate_propal: 
        rows: 
            - field: diagnostic
            - custom: 1
              data_type: bool
              input: 
                  type: toggle
              label: Notifier le client
              value: 1
              input_name: send_msg
            - custom: 1
              label: Montant devis
              content: 
                  callback: displayFactureAmountToPay
              input_name: inut
            
    resolution: 
        rows: 
            - field: resolution
            - custom: 1
              label: Dispo sous
              input_name: nbJours
              data_type: int
              min: 0
              value: 0
              input: 
                  addon_right: 
                      text: jour(s)
            - custom: 1
              data_type: bool
              input: 
                  type: toggle
              label: Notifier le client
              value: 1
              input_name: send_msg
            - custom: 1
              label: Montant facture
              input_name: inut
              content: 
                  callback: displayFactureAmountToPay
              
    equipment: 
        rows: 
            - custom: 1
              data_type: string
              input: 
                  type: text
              label: Numéro de série
              input_name: serial
              
    wait_client: 
        rows: 
            - custom: 1
              label: Informations
              data_type: string
              input_name: infos
              input: 
                  type: textarea
                  rows: 3
                  auto_expand: 1
                  values: 
                      array: list_wait_infos
                      
    acompte_mode_paiement: 
        rows: 
            - custom: 1
              label: Paiement
              hidden: 1
              input_name: id_paiement
              hidden: 1
              input: 
                  type: hidden
            - custom: 1
              label: Mode de paiement
              input_name: mode_paiement
              input: 
                  type: select_payment
                  
    add_acompte:
        rows: 
            - field: acompte
            - label: Mode de paiement de l'acompte
              custom: 1
              data_type: int
              input_name: mode_paiement_acompte
              input: 
                  type: select_payment
                  include_empty: 1
#              display_if: 
#                  field_name: acompte
#                  hide_values: 0,
              value: 6
              
    gsx_token: 
        title: Authentification GSX
        rows: 
            - custom: 1
              label: GSX API Token 
              input_name: token
              input: 
                  type: text
                  help: Veuillez vous athentifier sur le site Apple GSX puis copier-coller le token obtenu. 
                  extra_content: 
                      callback: renderGsxTokenInputExtraContent
              required: 1  
              
    cancel_rdv: 
        title: Annulation du RDV
        rows: 
            - custom: 1
              label: Raison
              input_name: cancel_reason
              input: 
                  type: select
                  options: 
                      array: rdv_cancel_reasons
              
fields_tables: 
    infos: 
        title: Informations
        icon: info-circle
        footer_extra_btn: 
            callback: getInfosExtraBtn
        rows: 
            - field: replaced_ref
              show: 
                  field_value: replaced_ref
            - field: ref
            - field: date_rdv
            - field: resgsx
            - field: status
              display: actions
            - field: code_centre
            - field: code_centre_repa
            - field: id_entrepot
              display: nom_url
            - field: id_user_tech
              display: nom_url
            - field: id_equipment
              display: card
            - field: id_ticket
              display: card
            - field: prioritaire
            - field: sav_pro
              edit: 1
            - field: prestataire_number
            - label: Autre
              value:
                 callback: displayExtraSav
            - field: date_terminer
            - label: Lien publique
              value:
                 callback: displayPublicLink
                 
    facturation:
        title: Facturation
        icon: fas_euro-sign
        rows: 
            - field: id_facture_acompte
              display: card
              show: 
                  field_value: id_facture_acompte
            - field: id_facture_avoir
              display: card
              show: 
                  field_value: id_facture_avoir
            - field: id_facture
              display: card
              show: 
                  field_value: id_facture
              
    client: 
        title: Client
        icon: user-circle
        footer_extra_btn: 
            callback: getClientExtraBtn
        rows:
            - field: id_contrat
              display: card
              show: 
                  field_value: id_contrat
            - label: Client
              field: id_client
              display: card
            - field: id_contact
              display: card
              show: 
                  field_value: id_contact
            - field: id_user_client
            - field: contact_pref
              edit: 1
              
    materiel: 
        title: Matériel
        icon: fas_box
        rows: 
            - field: id_equipment
              display: card
            - field: accessoires
              edit: 1
            - field: etat_materiel
              edit: 1
            - field: etat_materiel_desc
              edit: 1
            - field: save_option
              edit: 1
            - field: system
            - field: login_admin
            - field: pword_admin
              
    suivi:
        title: Suivi
        icon: fas_file-alt
        rows: 
#            - field: date_problem
            - field: symptomes
              edit: 1
            - field: diagnostic
              edit: 1
            - field: resolution
              edit: 1
            - field: extra_infos
              edit: 1
              
    public_infos: 
        panel: 0
        rows: 
            - field: code_centre
            - field: id_user_tech
            - field: id_equipment
              label: Matériel
              display: custom
            - field: accessoires
            - field: id_ticket
              label: Ticket support
              display: nom_url
              show: 
                  field_value: id_ticket
            - field: id_contrat
              display: card
              show: 
                  field_value: id_contrat
            - field: id_contact
              display: card
              show: 
                  field_value: id_contact
            - field: contact_pref
              
    public_suivi: 
        panel: 0
        rows: 
            - field: system
            - field: etat_materiel
            - field: etat_materiel_desc
            - field: symptomes
            - field: diagnostic
            - field: resolution
            - field: extra_infos
              label: Informations supplémentaires
              
views: 
    default: 
        title: 
            callback: getRef
        objects_change_reload: BS_SavProduct,BS_ApplePart,Bimp_Paiement
        rows:
            - cols: 
                  - type: object_header
            - cols: 
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: infos
                  
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table:
                        name: client
                        
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table:
                        name: facturation
            - cols: 
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: materiel
                  
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table:
                        name: suivi
            - cols: 
                - type: list
                  list: 
                      name: default
                      children: prets
                      
    infos:
        title: 
            callback: getRef
        delete_btn: 1
        edit_form: edit
        objects_change_reload: BS_SavProduct,BS_ApplePart,Bimp_Paiement
        rows:
            - cols: 
                - type: fields_table
                  col_lg: 6
                  col_md: 6
                  fields_table: 
                      name: infos
                  
                - type: fields_table
                  col_lg: 6
                  col_md: 6
                  fields_table:
                      name: client
                  
                - type: fields_table
                  col_lg: 6
                  col_md: 6
                  fields_table:
                      name: facturation
            - cols: 
                - type: custom
                  col_lg: 6
                  col_md: 6
                  custom: 
                      callback: renderPropalesList            
                      
    propal: 
        panel: 0
        rows: 
            - cols: 
                - type: custom
                  custom: 
                      callback: renderPropalView
            - cols: 
                - type: custom
                  custom: 
                      callback: renderApplePartsList
            - cols: 
                - type: custom
                  custom: 
                      callback: renderLoadPartsButton
            
    materiel:
        panel: 0
        rows:    
            - cols: 
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: materiel
                        
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: suivi
    
    public_client: 
        panel: 0
        rows:
            - cols: 
                  - type: object_header
            - cols: 
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: public_infos
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: public_suivi
    
filters_panels: 
    default: 
        filters: 
            ref:
            status:
            date_create:
            id_equipment:
            code_centre:
            code_centre_repa: 
            id_user_tech:
            id_client:
            id_facture:
            id_facture_avoir:
            id_facture_acompte:
            prestataire_number:
            sav_pro:
            facture:facnumber:
        
lists_cols: 
    code_centre: 
        label: Centre (PeC)
    code_centre_repa: 
        label: Centre (Rép.)
    id_equipment: 
        display: custom
        
lists: 
    default: 
        title: Liste des SAV
        configurable: 1
        checkboxes: 1
        bulk_actions:
            - label: supprimer les SAV sélectionnés
              icon: fas_trash-alt
              onclick: deleteSelectedObjects('list_id', $(this))
        list_filters: 
            callback: getListFilters
        filters_panel: default
        sort_field: date_create
        sort_way: desc
        n: 10
        add_form_name: default
        add_form_values: 
            fields: 
                id_entrepot: 
                    request: id_entrepot
        add_btn_label: Nouveau SAV
        edit_btn: 1
        edit_form: edit
        delete_btn: 1
        page_btn: 1
        modal_view: default
        extra_btn: 
            callback: getListExtraBtn
        cols: 
            ref:
            code_centre: 
            status: 
            date_create:
            id_user_tech:
            id_client: 
            id_equipment:
                
    client: 
        extends: default
        cols:
            client: unset
    
    public_client: 
        title: Liste des SAV
        configurable: 0
        checkboxes: 0
        sort_field: date_create
        sort_way: desc
        n: 10
        edit_btn: 1
        edit_form: public_edit
        extra_btn: 
            callback: getPublicListExtraButtons
        cols: 
            ref:
            date_create:
            code_centre: 
            status: 
            id_user_tech:
            id_equipment:
    
cards:
    default:
        title: 
            field_value: ref
        status: status
        fields: 
            - field: replaced_ref
            - label: Technicien
              field: id_user_tech
              display: nom_url
            - label: Matériel
              field: id_equipment
              display: nom_url
            - label: Client
              field: id_client
              display: nom_url
        view_btn: 1

searches:
    default: 
        fields_search: 
            - e.serial
            - e.imei
            - a.ref
            - s.nom
            - r.repair_confirm_number
            - r.repair_number
        fields_return: 
            - a.ref
            - s.nom
        label_syntaxe: '<a.ref> (<s.nom>)'
        joins: 
            - table: be_equipment
              on: a.id_equipment = e.id
              alias: e
            - table: societe
              on: a.id_client = s.rowid
              alias: s
            - table: bimp_gsx_repair
              alias: r
              on: a.id = r.id_sav
                      
pages: 
    default: 
        nav_tabs: 
            - id: card
              title: Fiche SAV
              struct: 
                  type: rows
                  rows: 
                      - cols: 
                          - type: custom
                            custom: 
                                callback: renderSavCheckup
                      - cols: 
                          - type: view
                            view:
                                name: infos
                              
                      - cols: 
                          - type: custom
                            col_lg: 6
                            col_md: 6
                            custom: 
                                callback: renderPropalesList
            - id: materiel
              title: Matériel
              struct: 
                  type: rows
                  rows: 
                      - cols: 
                          - type: view
                            view: 
                                name: materiel
                      - cols: 
                          - type: list
                            list:
                                name: sav
                                children: prets
            - id: devis
              title: Devis
              struct: 
                  type: rows
                  rows: 
                      - cols: 
                          - type: custom
                            custom: 
                                callback: renderPropalView
                                  
                      - cols: 
                          - type: list
                            list: 
                                children: apple_parts
#                      - cols: 
#                          - type: custom
#                            custom: 
#                                callback: 
#                                    method: renderLoadPartsButton
#                                    params:
#                                        object: sav
#            - id: notes
#              title: Notes
#              struct:
#                  type: notes
#                  notes: 
#                      visibility: 4
#            - id: gsx
#              title: <i class="fa fa-apple iconLeft"></i>GSX
#              content: 
#                  callback: renderGsx
