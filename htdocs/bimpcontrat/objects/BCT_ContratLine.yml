dol_object: 
    instance: 
        dol_object: 
            module: contrat
            file: contrat
            class: ContratLigne
            
table: contratdet
primary: rowid
    
positions: 1
position_insert: after
position_field: rang

labels: 
    name: ligne de contrat
    name_plur: lignes de contrat
    is_female: 1
   
parent_module: bimpcontrat
parent_object: BCT_Contrat
parent_id_property: fk_contrat

nom_url: 
    modal_view: 
        callback: getModalView
        
objects: 
    product: 
        instance: 
            id_object: 
                field_value: fk_product
    
    fourn_price: 
        relation: hasOne
        delete: 0
        instance: 
            bimp_object: 
                module: bimpcore
                name: Bimp_ProductFournisseurPrice
            id_object: 
                field_value: fk_product_fournisseur_price
        
    user_author: 
        extends: user
        instance: 
            id_object: 
                field_value: fk_user_author
                
    user_ouverture: 
        extends: user
        instance: 
            id_object: 
                field_value: fk_user_ouverture
                
    user_cloture: 
        extends: user
        instance: 
            id_object: 
                field_value: fk_user_cloture
                
    linked_line: 
        relation: hasOne
        delete: 0
        instance: 
            bimp_object: 
                module: bimpcontrat
                name: BCT_ContratLine
            id_object: 
                field_value: id_linked_line             
                
    line_renouv: 
        extends: linked_line
        instance: 
            id_object: 
                field_value: id_line_renouv
                
fields: 
    fk_contrat: 
        label: Contrat
        type: id_parent
        required: 1
        
    fk_product: 
        label: Produit / service
        type: id_object
        object: product
            
    line_type: 
        label: Type
        type: int
        values:
            array: types
        required: 1
        
    statut: 
        label: Statut
        type: int
        values: 
            array: status_list
            
    label: 
        label: Libellé
        
    description: 
        label: Description
        type: html
        depends_on: fk_product
        
    commentaire: 
        label: Commentaire
        type: text
    
    product_type: 
        label: Type produit
        type: int
        values: 
            0: Produit
            1: Service
            
    qty: 
        label: Qté totale
        type: float
        decimals: 8
        default_value: 0
        input: 
            type: qty
            help: Pour les abonnements à quantité variable, la quantité correspond à une estimation de consommation par période de facturation
        displays: 
            details: 
                label: Affichage détaillé
                type: callback
                method: displayQties
        
    price_ht: 
        label: PU HT remisé
        type: money
        depends_on: fk_product
        
    subprice: 
        label: Prix unitaire HT
        type: money
        decimals: 4
        depends_on: fk_product
        
    tva_tx: 
        label: Tx TVA
        type: float
        default_value: 
            callback: 
                method: cacheServeurFunction
                params:
                    - getDefaultTva
        depends_on: fk_product
            
    remise_percent: 
        label: Remise (%)
        type: percent
        default_value: 0
        
    fk_product_fournisseur_price: 
        label: Prix d'achat fournisseur
        type: id_object
        object: fourn_price
        depends_on: line_type,fk_product
        input: 
            type: custom
            content: 
                callback: renderFournPriceInput
        display_if: 
            field_name: achat_periodicity
            hide_values: 0
            
    buy_price_ht: 
        label: Prix d'achat HT
        type: money
        depends_on: fk_product,fk_product_fournisseur_price
        display_if: 
            field_name: achat_periodicity
            hide_values: 0    
    
    total_ht: 
        label: Total HT
        type: money
    
    total_tva: 
        label: Total TVA
        type: money
        
    total_ttc: 
        label: Total TTC
        type: money
        
    fac_periodicity: 
        label: Périodicité de facturation
        values: 
            array: periodicities
        default_value: 0
        depends_on: fk_product,id_linked_line
        displays: 
            default: 
                label: par défaut
                type: callback
                method: displayPeriodicity
                params: 
                    - fac
        
    fac_term: 
        label: Terme de facturation
        type: int
        default_value: 1
        depends_on: id_product,id_linked_line
        values: 
            0: A terme échu
            1: A terme à échoir
        depends_on: fk_product
        display_if: 
            field_name: fac_periodicity
            hide_values: 0    
        
    achat_periodicity: 
        label: Périodicité d'achat
        values: 
            array: periodicities
        default_value: 0
        depends_on: fk_product,id_linked_line
        
    duration: 
        label: Durée (en mois)
        type: int
        decimals: 0
        default_value: 0
        input: 
            type: qty
            possible_values: 
                array: 6,12,24,36,48,60
        depends_on: id_linked_line
        
    nb_renouv: 
        label: Nb renouvellements tacites
        type: int
        values: 
            array: nbRenouvellements
            
    variable_pu_ht: 
        label: Abonnement à prix de vente variable
        type: bool
        default_value: 0
        depends_on: fk_product
        
    variable_qty: 
        label: Abonnement à quantité variable
        type: bool
        default_value: 0
        depends_on: fk_product
        
    date_commande: 
        label: Date commande
        type: datetime
        
    date_ouverture_prevue: 
        label: Date ouverture prévue
        type: datetime
        input: 
            with_hours: 0
        
    date_ouverture: 
        label: Date ouverture
        type: datetime
        input: 
            display_now: 1
            with_hours: 0
        
    date_debut_validite: 
        label: Date de début de validité
        type: date
        
    date_fin_validite: 
        label: Date fin validité
        type: datetime
        
    date_cloture: 
        label: Date de cloture
        type: datetime
        
    date_fac_start: 
        label: Date de début de facturation
        type: date
        input: 
            help: Laisser vide pour utiliser la date d'ouverture
        
    date_next_facture: 
        label: Date de prochaine facturation
        type: date
        displays: 
            with_color: 
                type: callback
                method: displayNextFacDate
                params: 
                    - 1
        
    date_achat_start: 
        label: Date de début d'achat
        type: date
        input: 
            help: Laisser vide pour utiliser la date d'ouverture
        
    date_next_achat: 
        label: Date de prochain achat
        type: date
        displays: 
            with_color: 
                type: callback
                method: displayNextAchatDate
                params: 
                    - 1
        
    fk_user_author: 
        label: Créé par
        type: id_object
        object: user_author
        
    fk_user_ouverture: 
        label: Ouvert par
        type: id_object
        object: user_ouverture
        
    fk_user_cloture: 
        label: Clos par
        type: id_object
        object: user_cloture
        
    id_linked_line: 
        label: Abonnement lié
        type: id_object
        object: linked_line
        default_value: 0
        input: 
            type: select
            options: 
                array: linkableContratLines
            help: 'Si un abonnement est sélectionné, les unités seront facturées au prorata de la durée restante de cet abonnement.<br/>Toutes les unités pourront ainsi être renouvellées simultanément'
        depends_on: fk_product,type_linked_line
        
    id_line_renouv: 
        label: Ligne de renouvellement
        type: id_object
        object: line_renouv
        
    linked_object_name:
        label: Type d\'objet lié
        
    linked_id_object: 
        label: Objet lié
        type: int
        default_value: 0
    
    line_origin_type: 
        label: Type de ligne d'origine
        
    id_line_origin: 
        label: ID Ligne d\'origine
        type: id
        default_value: 0

    id_parent_line:
        label: Ligne parente
        type: id
        default_value: 0
        viewable: 0
        filterable: 1
        input: 
            type: hidden
        
    linked_id_object: 
        label: Objet lié
        type: int
        default_value: 0
        
    linked_object_name:
        label: Type d\'objet lié
        
    fac_ended: 
        label: Facturations terminées
        type: bool
        default_value: 0
        
    achat_ended: 
        label: Achats terminés
        type: bool
        default_value: 0
        
    renouv_task: 
        label: Tâche de renouvellement créée
        type: bool
        default_value: 0

forms: 
    text: 
        rows: 
            - custom: 1
              hidden: 1
              label: Type
              input_name: line_type
              input: 
                  type: hidden
              value: 1
            - field: description
            
    abonnement: 
        rows: 
            - custom: 1
              hidden: 1
              label: Type
              input_name: line_type
              input: 
                  type: hidden
              value: 2
            - field: fk_product
            - field: description
            - custom: 1
              label: Lier à un abonnement d'une ref différente
              input_name: type_linked_line
              data_type: bool
              input:
                  type: toggle
              value:
                  callback: isLinkedToOtherRef
            - field: id_linked_line
            - field: date_ouverture_prevue
            - title: vente
            - field: date_fac_start
            - field: fac_periodicity
            - field: fac_term
            - field: variable_pu_ht
            - field: variable_qty
            - field: duration
            - custom: 1
              label: Quantité par facturation
              input_name: qty_per_period
              input: 
                  type: qty
                  help: Pour les abonnements à quantité variable, indiquez une estimation de la consommation par période facturée
              value: 
                  callback: getFacQtyPerPeriod
              edit: 
                  callback: 
                      method: isFieldEditable
                      params: 
                          - qty
            - custom: 1
              label: Quantité totale
              input_name: total_qty
              input: 
                  type: custom
                  content: 
                      callback: displayAboTotalQty
              depends_on: fac_periodicity,qty_per_period,duration
            - field: nb_renouv
            - field: subprice
            - field: tva_tx
            - field: remise_percent
            
            - title: Achat
            - field: date_achat_start
            - field: achat_periodicity
#            - custom: 1
#              label: Type de prix d'achat
#              input_name: type_pa
#              data_type: int
#              input: 
#                  type: select
#                  options: 
#                      pa_fourn: Prix fournisseur
#                      custom: Personnalisé
            - field: fk_product_fournisseur_price
#              display_if: 
#                  field_name: type_pa
#                  hide_values: custom
#            - field: achat_id_fourn
            - field: buy_price_ht
            
    activate: 
        rows: 
            - field: date_ouverture_prevue
            - field: id_linked_line
            
    bulk_activate: 
        rows: 
            - custom: 1
              label: Date d'ouverture
              input_name: date_ouverture_prevue
              data_type: date
              input: 
                  type: date
            - field: id_linked_line
        
    bulk_edit: 
        msgs: 
            - type: warning 
              content: Seules les lignes inactives seront éditées
        rows: 
            - custom: 1
              label: Date d'ouverture prévue
              input_name: date_ouverture_prevue
              data_type: date
              input: 
                  type: date
            - custom: 1
              label: Date de début des facturations
              input_name: date_fac_start
              data_type: date
              input: 
                  type: date
            - custom: 1
              label: Date de début des achats
              input_name: date_achat_start
              data_type: date
              input: 
                  type: date
            
    periodic_process: 
        modal_format: large
        rows: 
            client: 
                custom: 1
                hidden: 1
                label: Client
                input_name: id_client
                input: 
                    type: hidden
                value: 0
                edit: 1
            client_name: 
                custom: 1
                label: Client
                input_name: client_name
                input: 
                    type: custom
                    content: 
                        callback: displayClientNameInput
                depends_on: id_client
                display_if: 
                    field_name: id_client
                    hide_values: 0
            fourn: 
                custom: 1
                hidden: 1
                label: Fournisseur
                input_name: id_fourn
                input: 
                    type: hidden
                value: 0
                edit: 1
            fourn_name: 
                custom: 1
                label: Fournisseur
                input_name: fourn_name
                input: 
                    type: custom
                    content: 
                        callback: displayFournNameInput
                depends_on: id_fourn
                display_if: 
                    field_name: id_fourn
                    hide_values: 0
            product: 
                custom: 1
                hidden: 1
                label: Produit
                input_name: id_product
                input: 
                    type: hidden
                value: 0
                edit: 1
            prod_name: 
                custom: 1
                label: Produit
                input_name: prod_name
                input: 
                    type: custom
                    content: 
                        callback: displayProductNameInput
                depends_on: id_product
                display_if: 
                    field_name: id_product
                    hide_values: 0
            contrat: 
                custom: 1
                hidden: 1
                label: Contrat
                input_name: id_contrat
                input: 
                    type: hidden
                value: 0
                edit: 1
            contrat_name: 
                custom: 1
                label: Contrat
                input_name: Contrat_name
                input: 
                    type: custom
                    content: 
                        callback: displayContratNameInput
                depends_on: id_product
                display_if: 
                    field_name: id_product
                    hide_values: 0
            type: 
                custom: 1
                label: Type opération
                input_name: operation_type
                hidden: 1
                input: 
                    type: hidden
                required: 1
#            fac_mode: 
#                custom: 1
#                label: Factuation à traiter
#                input_name: fac_mode
#                data_type: int
#                input: 
#                    type: select
#                    options: 
#                        1: Mois en cours
#                        2: A date
#                value: 
#                    conf: 
#                        module: bimpcontrat
#                        name: default_fac_mode
#                show: 
#                    conf: 
#                        module: bimpcontrat
#                        name: allow_fac_mois_en_cours
#                display_if: 
#                    field_name: type
#                    show_values: fac
            products: 
                custom: 1
                label: Produits à traiter
                input_name: products
                input: 
                    type: custom
                    content: 
                        callback: renderPeriodicProcessInputs
                        
    add_units: 
        title: Ajout / retrait d\'unité
        rows: 
            - custom: 1
              label: Ajouter à un devis
              input_name: id_propal
              input: 
                  type: select
                  options: 
                      callback: getClientPropalesArray
              value: 
                  callback: getLastClientPropalId
            - custom: 1
              label: Date d'ouverture prévue
              input_name: date_ouv
              data_type: date
              required: 1
              input: 
                  type: date
                  help: Obligatoire pour le calcul du prorata de facturation, pourra être modifiée ultérieurement
            - custom: 1
              label: Libellé nouveau devis
              input_name: propal_label
              input: 
                  type: text
              display_if: 
                  field_name: id_propal
                  show_values: 0
            - custom: 1
              label: Nombre d\'unités à ajouter / retirer
              input_name: nb_units
              content: 
                  callback: renderAddUnitsInputs
        
    renouvellement: 
        title: Renouvellement
        force_edit: 1
        rows: 
            - custom: 1
              label: Ajouter le renouvellement à un devis
              input_name: id_propal
              input: 
                  type: select
                  options: 
                      callback: getClientPropalesArray
              value: 
                  callback: getLastClientPropalId
            - custom: 1
              label: Libellé nouveau devis
              input_name: propal_label
              input: 
                  type: text
              display_if: 
                  field_name: id_propal
                  show_values: 0
            - custom: 1
              label: Lignes liées à fusionner
              input_name: linked_lines
              content: 
                  callback: 
                      method: renderLinkedLinesCheckInputs
                      params: 
                          - renouv
            - custom: 1
              label: Prix unitaire HT
              input_name: renouv_subprice
              data_type: money
              input: 
                  type: text                  
              value: 
                  callback: 
                      method: getValueForProduct
                      params: 
                        - subprice
            - field: fac_periodicity
            - field: duration
            - field: fac_term
            - field: achat_periodicity
            
    bulk_renouvellement:
        title: Renouvellement
        rows: 
            - custom: 1
              label: Ajouter le renouvellement à un devis
              input_name: id_propal
              input: 
                  type: select
                  options: 
                      callback: getClientPropalesArray
              value: 
                  callback: getLastClientPropalId
            - custom: 1
              label: Libellé nouveau devis
              input_name: propal_label
              input: 
                  type: text
              display_if: 
                  field_name: id_propal
                  show_values: 0
            
    fac_regul: 
        rows: 
            - custom: 1
              label: Facture
              input_name: id_fac_regul
              content: 
                  callback: renderRegulFactureSelect
            - custom: 1
              label: Libellé facture
              input_name: fac_libelle
              input: 
                  type: text
              display_if: 
                  field_name: id_fac_regul
                  show_values: 0
#            - custom: 1
#              label: Période du
#              input_name: period_from
#              content: 
#                  callback: renderFacRegulFromSelect
            - custom: 1
              label: Au
              input_name: period_to
              content: 
                  callback: renderFacRegulToSelect
              depends_on: period_from
            - custom: 1
              label: Quantité
              input_name: regul_qty
              content: 
                  callback: renderFacRegulQtyInput
              depends_on: period_to
              
    date_cloture: 
        rows: 
            - custom: 1
              label: Date d'arrêt de l'abonnement
              input_name: date_cloture
              content: 
                  callback: renderClotureDateInput
            - custom: 1
              label: Lignes liées concernées
              input_name: linked_lines
              content:  
                  callback: 
                      method: renderLinkedLinesCheckInputs
                      params: 
                          - setResiliateDate
              
fields_tables: 
    infos: 
        title: Informations
        icon: fas_info-circle
        rows: 
            - field: line_type
            - field: statut
            - field: fk_contrat
            - field: fk_product
              display: card
            - field: description
            - field: commentaire       
            - field: date_commande
            - field: date_ouverture_prevue
            - field: date_fin_validite
            
    amounts: 
        title: Qté et montants
        icon: fas_euro-sign
        rows: 
            - field: qty
            - field: subprice
            - field: tva_tx
            - field: remise_percent
            - field: price_ht
            - field: total_ht
            - field: total_tva
            - field: total_ttc
            
    facturation: 
        title: Facturation
        icon: fas_file-invoice-dollar
        rows: 
            - field: date_fac_start
            - field: fac_periodicity
            - field: duration
            - label: nombre total de périodes
              value: 
                  callback: getFacNbPeriods
            - field: variable_pu_ht
            - field: variable_qty
            - label: Qté par période
              value: 
                  callback: getFacQtyPerPeriod
                  
    achat: 
        title: Achat
        icon: fas_cart-arrow-down
        rows: 
            - field: date_achat_start
            - field: fk_product_fournisseur_price
            - field: buy_price_ht
            - field: achat_periodicity
            
    desc: 
        panel: 0
        rows: 
            - field: fk_contrat
            - field: description
            
views: 
    default: 
        rows: 
            - cols: 
                - type: object_header
                
    text: 
        extends: default
        rows: 
            1: 
                cols: 
                    - type: fields_table
                      col_lg: 6
                      col_md: 6
                      fields_table: 
                          name: desc
                          
    abonnement: 
        extends: default
        rows: 
            1: 
                cols: 
                    - type: fields_table
                      col_lg: 6
                      col_md: 6
                      fields_table: 
                          name: infos
                    - type: fields_table
                      col_lg: 6
                      col_md: 6
                      fields_table: 
                          name: amounts
            2: 
                cols: 
                    - type: fields_table
                      col_lg: 6
                      col_md: 6
                      fields_table: 
                          name: facturation
                    - type: fields_table
                      col_lg: 6
                      col_md: 6
                      fields_table: 
                          name: achat            
        
filters:
    periodic_facs_to_process: 
        label: Facturation périodiques à traiter aujourd'hui
        type: check_list
        items: 
            1: OUI
            0: NON
            
    periodic_achats_to_process: 
        label: Achats périodiques à traiter aujourd'hui
        type: check_list
        items: 
            1: OUI
            0: NON
            
filters_panels: 
    default: 
        filters: 
            fk_contrat: 
            statut: 
            fk_product:
            
    periods: 
        filters: 
            parent:ref:
                label: Ref. Commande
            parent:statut:
                label: Statut contrat
                
    fac_periods: 
        extends: periods
        filters: 
            periodic_facs_to_process:
            date_next_facture: 
            fac_periodicity:
                
    achat_periods: 
        extends: periods
        filters: 
            periodic_achats_to_process:
            date_next_achat: 
            achat_periodicity:
                
lists_cols: 
    qty: 
        min_width: 200
    desc: 
        label: Désignation
        value: 
            callback: displayDesc
        min_width: 250
            
    fac_infos: 
        label: Infos facturation
        value: 
            callback: displayFacInfos
        min_width: 250
            
    achat_infos: 
        label: Infos achat
        value: 
            callback: displayAchatInfos
        min_width: 250
            
    nb_facs_todo: 
        label: Facturation a effectuer à date
        value: 
            callback: displayNbFacsToProcess
            
    nb_achats_todo: 
        label: Achats a effectuer à date
        value: 
            callback: displayNbAchatsToProcess
        
    date_next_facture:
        display: with_color
        
    date_next_achat:
        display: with_color
        
    origine: 
        label: Origine
        value: 
            callback: displayLineOrigin
            
lists: 
    default: 
        configurable: 1
        checkboxes: 1
        item_checkbox: 
            callback: areBulkActionsAllowed
        filters_panel: default
        sort_field: rowid
        sort_way: desc
        n: 10
        edit_btn: 1
        edit_form: 
            callback: getEditForm
        delete_btn: 1
        modal_view: 
            callback: getModalView
        extra_btn: 
            callback: getListExtraBtn
        single_cell:
            filters:
                line_type: 1
            col: desc
        bulk_actions: 
            callback: 
                method: getListsBulkActions
                params: 
                    - default
        cols: 
            fk_contrat:
            desc:
            qty:
                display: details
            subprice: 
            tva_tx: 
            remise_percent: 
            total_ttc: 
            fac_infos: 
            achat_infos:
            statut: 
            origine:
                
    global:
        extends: default
        list_filters: 
            - name: parent.version
              filter: 2
        joins: 
            parent: 
                table: contrat
                on: parent.rowid = a.fk_contrat
                alias: parent
        bulk_actions: 
            callback: 
                params: 
                    - global
        
    contrat: 
        extends: default
        objects_change_reload: BCT_Contrat
        sort_field: rang
        sort_way: asc
        positions: 1
        n: 0
        header_buttons: 
            callback: 
                method: getListHeaderButtons
                params: 
                    - contrat
        bulk_actions: 
            callback: 
                params: 
                    - contrat
        cols: 
            fk_contrat: unset
            
    facturation: 
        extends: default
        filters_panel: fac_periods
        sort_field: date_next_facture
        sort_way: asc
        checkboxes: 
            callback: 
                method: canSetAction
                params: 
                    - periodicFacProcess
        bulk_actions: 
            callback: 
                method: getListsBulkActions
                params: 
                    - facturation
        header_buttons: 
            callback: 
                method: getListHeaderButtons
                params: 
                    - facturation
        cols: 
            unextends: 1
            fk_contrat:
            desc:
            qty:
                display: details
            total_ttc:
            statut:
            fac_infos: 
            nb_facs_todo: 
            date_next_facture:
                
    achat: 
        extends: default
        item_checkbox: 1
        filters_panel: achat_periods
        sort_field: date_next_achat
        sort_way: asc
        checkboxes:
            callback: 
                method: canSetAction
                params: 
                    - periodicAchatProcess
        bulk_actions: 
            callback: 
                method: getListsBulkActions
                params: 
                    - achat
        header_buttons: 
            callback: 
                method: getListHeaderButtons
                params: 
                    - achat
        cols: 
            unextends: 1
            fk_contrat:
            desc:
            qty:
                display: details
            total_ttc:
            statut:
            achat_infos: 
            nb_achats_todo: 
            date_next_achat:
            