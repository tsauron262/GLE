table: bs_ticket
controller: ticket

icon: fas_headset
public_icon: pe_headphones

nom_url: 
    syntaxe: <ticket_number>
    
entity_name: bs_ticket
    
header_list_name: default
header_btn: 
    callback: getHeaderButtons
    
list_page_url: 
    controller: index
    url_params: 
        tab: default
            
labels:
    name: ticket hotline
    name_plur: tickets hotline

objects:
    bimp_contrat:
        relation: hasOne
        delete: 0
        instance:
            bimp_object:
                module: bimpcontract
                name: BContract_contrat
            id_object: 
                field_value: id_contrat
                
    bimp_service:
        relation: hasOne
        delete: 0
        instance:
            bimp_object:
                module: bimpcommercial
                name: Bimp_CommandeLine
            id_object: 
                field_value: id_service
               
    user_resp: 
        extends: user
        instance: 
            id_object: 
                field_value: id_user_resp
                
    user_client:
        relation: hasOne
        delete: 0
        instance:
            bimp_object:
                module: bimpinterfaceclient
                name: BIC_UserClient
            id_object: 
                field_value: id_user_client
            
    inters:
        relation: hasMany
        delete: 1
        instance: 
            bimp_object: 
                module: bimpsupport
                name: BS_Inter
        
    bs_notes:
        relation: hasMany
        delete: 1
        instance:
            bimp_object: 
                module: bimpsupport
                name: BS_Note
                
    files:
        instance:
            bimp_object:
                module: bimpcore
                name: BimpFile
                
        list: 
            filters:
                parent_module: bimpsupport
                parent_object_name: BS_Ticket
                
        add_form: 
            name: upload
            values:
                fields: 
                    parent_module: bimpsupport
                    parent_object_name: BS_Ticket
            
associations:
    equipments:
        object: equipment
        depends_on: id_contrat
        label: Equipements concernés
        display: 
            default: 
                type: callback
        list: 
            array: equipments

fields:    
    id_contrat:
        label: Contrat
        type: id_object
        object: bimp_contrat
        input: 
#            type: search_object
#            card: default
#            help: Entrez la référence ou l'objet du contrat ou le nom du client pour effectuer une recherche
            type: search_list
            card: default
            search_list:
                table: contrat
                field_return_value: a.rowid
                field_return_label: a.ref
                join: societe s
                join_on: a.fk_soc s.rowid
                join_return_label: s.nom
                filters: 
                    callback: getContratInputFilters
                options:    
                    default:
                        label: Recherche par client
                        fields_search: s.nom,s.code_client
                        join: societe s
                        join_on: a.fk_soc = s.rowid
                        join_return_label: s.nom
                        help: Entrez le nom ou le code d'un client
                    by_ref:
                        label: Recherche par référence contrat
                        fields_search: a.ref,a.rowid
                        join: societe s
                        join_on: a.fk_soc = s.rowid
                        join_return_label: s.nom
                        help: Entrez la référence ou l'ID d'un contrat
                    by_obj:
                        label: Recherche l'objet du contrat
                        fields_search: e.objet_contrat, a.rowid
                        join: contrat_extrafields e
                        join_on: e.fk_object = a.rowid
                        join_return_value: a.fk_soc
                        join_return_label: e.objet_contrat
                        help: Entrez l'objet du contrat
        display_if: 
            field_name: no_contrat
            hide_values: 1
    serial:
        label: N° de série
    id_service:
        label: Service
        type: id_object
        object: bimp_service
        input: 
            type: search_list
            card: default
            search_list:
                table: view_hotline_commande
                field_return_value: a.line_id
                field_return_label: a.ref
                join: societe s
                join_on: a.soc_id = s.rowid
                join_return_label: s.nom
                fields_search: s.nom,s.code_client
#                filters: 
#                    callback: getServiceInputFilters
                
        display_if: 
            field_name: no_contrat
            hide_values: 1
    id_client:
        label: Client
        type: id_object
        object: client
        create_form: client_light
        input: 
            card: default
        search:
            input: 
                type: search_societe
                societe_type: customer  
    id_user_client:
        label: Demandeur
        type: id_object
        object: user_client      
    id_contact:
        label: Contact
        type: id_object
        object: contact
        create_form: default
        create_form_values: 
            fields: 
                fk_soc: 
                    callback: getPostIdClient
        values: 
            array: client_contacts
        depends_on: id_client_contrat,id_client,id_client_service
        display_if: 
            field_name: no_client
            hide_values: 1
        search:
            input:
                type: search_list
                search_list:
                    table: socpeople
                    field_return_value: rowid
                    field_return_label: lastname,firstname
                    fields_search: lastname,firstname
                    label_syntaxe: <label_1> <label_2>               
    id_user_resp: 
        label: Responsable
        type: id_object
        object: user_resp
        input: 
            type: hidden
        default_value:
            prop:
                name: id
                object: 
                    global: user
        search:
            input: 
                type: search_user
    ticket_number:
        label: N° ticket
        type: string
        required: 0
        search:
            input: 
                type: text
            type: value_part
            search_on_key_up: 1
        input: 
            type: hidden
    priorite: 
        label: Priorité
        type: int
        default_value: 1
        values: 
            array: priorities
        displays: 
            icon:
                icon_only: 1
    impact:
        label: Impact
        type: int
        values: 
            array: impacts
        default_value: 1
        displays: 
            icon:
                icon_only: 1    
    impact_demande_client:
        label: Impact lors de la demande client
        type: int
        values: 
            array: impacts
        show:
            callback: isUserClientRequest
    priorite_demande_client:
        label: Priorité lors de la demande client
        type: int
        values:
            array: priorities
        show:
            callback: isUserClientRequest
    contact_in_soc:
        label: Nom du contact
        type: string
        show:
            callback: isUserClientRequest
    cover:
        label: Type de couverture
        type: int
        values: 
            array: cover_types
        input: 
            options:
                array: coverTypesInput
        depends_on: no_contrat
        displays: 
            icon:
                icon_only: 1
    status: 
        label: Statut
        type: int
        values: 
            array: status_list
        default_value: 1
    appels_timer:
        label: Durée totale des appels payants
        type: time_last
        input: 
            type: timer
        default_value: 0
        displays: 
            default: 
                type: timer
        searchable: 0 
    sujet:
        label: Sujet ticket
        type: html
        required: 1
        hashtags: 1
    sujetInterne:
        label: Sujet ticket interne
        type: text
        required: 0
        hashtags: 1
    date_create:
        displays: 
            default: 
                type: datetime
                show_hour: 1
        
forms: 
    default:
        rows: 
            - custom: 1
              label: Client sans couverture
              input_name: no_contrat
              data_type: bool
              input: 
                  type: toggle
              value:
                  callback: hasNoContrat
            - custom: 1
              label: Pas de client
              input_name: no_client
              data_type: bool
              input: 
                  type: toggle
              value:
                  callback: hasNoClient
              display_if: 
                  field_name: no_contrat
                  show_values: 1
            - field: id_contrat
            - field: id_service
            - custom: 1
              input_name: id_client_contrat
              content: 
                  callback: renderClientContratInput
              label: Client 
              depends_on: id_contrat,id_client,no_contrat,no_client
              display_if: 
                  fields_names: no_contrat,id_contrat
                  no_contrat: 
                      show_values: 0
                  id_contrat: 
                      hide_values: 0,
              value: 0
            - custom: 1
              input_name: id_client_service
              content: 
                  callback: renderClientServiceInput
              label: Client 
              depends_on: id_service,id_client,no_contrat,no_client
              display_if: 
                  fields_names: no_contrat,id_service
                  no_contrat: 
                      show_values: 0
                  id_service: 
                      hide_values: 0,
              value: 0
            - field: id_client
              display_if:
                  fields_names: no_contrat,no_client
                  no_contrat:
                      show_values: 1
                  no_client:
                      hide_values: 1
              depends_on: id_contrat
            - field: id_contact
            - field: serial
            - field: sujet
            - field: priorite
            - field: status
            - field: impact
            - field: cover
#            - association: equipments
#              label: Equipements concernés
#              display_if: 
#                  field_name: id_contrat
#                  hide_values: 0,
#              depends_on: id_contrat
            - custom: 1
              label: Notifier par e-mail
              input_name: mails_to
              input: 
                  type: check_list
                  items: 
                      callback:
                          method: getNotificationsList
                          params: 
                              operation: create
                  value: 
                      array: comm,client,tech
#            - custom: 1
#              label: Appel payant du client en cours
#              data_type: bool
#              input_name: start_timer
#              input:
#                  type: toggle
            - object: inters
              multiple: 1
    
    close_inters: 
        rows: 
            - custom: 1
              label: Interventions à fermer
              input_name: inters_to_close
              input: 
                  type: check_list
                  items: 
                      array: openInters
              value: 
                  callback: 
                      method: getChildrenList
                      params: 
                          name: inters
                          filters: 
                              status: 
                                  operator: !=
                                  value: 2
                                  
    edit_ticket_interface:
        rows:
            - field: status
              edit: 0
            - field: priorite_demande_client
            - field: impact_demande_client
            - field: sujet
                                                        
    public_create:
        msgs:
            - content: Ne pas mettre d'informations confidentielles dans le sujet du ticket
              type: warning
        rows:
            client: 
                field: id_client
                edit: 0
            contrat: 
                custom: 1
                label: Contrat
                input_name: id_contrat
                input: 
                    type: select
                    options: 
                        array: newTicketContrats
            user_client: 
                field: id_user_client
                edit: 0
            contact_name: 
                field: contact_in_soc
                label: Nom du contact
            address: 
                custom: 1
                label: Adresse d'envoi
                input_name: adresse_envois
                input:
                    type: textarea
                    rows: 2
                    auto_expand: 1
            email: 
                custom: 1
                label: Adresse e-mail pour envoi du bon de retour
                input_name: email_bon_retour
                input:
                    type: text
            sujet: 
                field: sujet
                required: 1
            choix: 
                custom: 1
                label: Choix
                required: 1
                input_name: choix
                values: 
                  array: arrayTypeSerialImei
                input: 
                  type: switch_options
            serial: 
                custom: 1
                label: N° Série / N° IMEI ou Service
                required: 1
                input_name: serial_imei
                input: 
                    type: text
            priorite: 
                field: priorite
            impact: 
                field: impact
            notes: 
                object: bs_notes
                form_name: public_client
                multiple: 1
            files: 
                object: files
                multiple: 1
                form_name: public_upload
                form_values:
                    fields:
                        parent_module: bimpsupport
                        parent_object_name: BS_Ticket
                        id_parent: 1
                        
    public_create_from_contrat:
        extends: public_create
        rows: 
            contrat: 
                custom: 0
                field: id_contrat
                input: unset
                edit: 0
                
    public_edit:
        rows:
            - field: id_contrat
              edit: 0
            - field: status
              edit: 0
            - field: sujet
            - field: priorite
            - field: impact
                                                        
fields_tables: 
    infos: 
        title: Informations générales
        icon: info-circle
        rows: 
            - field: ticket_number
            - field: impact_demande_client
              edit: 0
            - field: priorite_demande_client
              edit: 0
            - field: contact_in_soc
              edit: 0
            - label: Durée totale interventions
              value:
                  callback: displayDureeTotale
#            - field: appels_timer
            - field: priorite
              edit: 1
            - field: impact
              edit: 1
            - field: cover
              edit: 1
            - field: status
              edit:
                  callback: isProcessing
            - field: serial
              edit: 1
            - label: Equipement
              value:
                  callback: displayEquipement
            - field: sujet
              edit: 0
            - field: sujetInterne
              help: remplace celui du client en vue liste
              edit: 1
              
    objects:
        title: Elements liés
        icon: share-alt
        rows:
            - field: id_user_resp
              display: card
            - field: id_contrat
              display: card
            - field: id_service
              display: card
            - label: Client
              field: id_client
              display: card
            - field: id_contact
              display: card
#            - association: equipments
#              label: Equipements concernés
              display: card
            - field: id_user_client
              display: card
    
    client_infos:
        title: Informations
        icon: info-circle
        
        rows:
            - field: sujet
            - field: status
            - field: priorite_demande_client
            - field: impact_demande_client
            - field: id_contrat
            - field: id_user_client
              
    public_infos: 
        panel: 0
        rows: 
            - field: sujet
            - field: id_user_resp
              label: Technicien
            - field: priorite
            - field: impact
            - field: cover
            
    public_objects: 
        panel: 0
        rows: 
            - field: id_contact
              show: 
                  field_value: id_contact
            - field: id_user_client
              show: 
                  field_value: id_user_client
            - field: id_contrat
              display: card
              show: 
                  field_value: id_contrat
            
views: 
    default:
        delete_btn: 1
        edit_form: default
        objects_change_reload: BS_Inter
        rows:
            - cols: 
#                  - type: rows
#                    col_lg: 5
#                    col_md: 6
#                    col_sm: 12
#                    rows: 
#                        - cols:
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: infos
#                        - cols: 
#                            - type: custom
#                              col_lg: 12
#                              custom:
#                                  callback: renderChronoView
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table:
                        name: objects
                        
    full: 
        objects_change_reload: BS_Inter
        rows: 
            - cols: 
                - type: object_header
            - cols: 
#                - type: rows
#                  col_lg: 5
#                  col_md: 6
#                  col_sm: 12
#                  rows: 
#                      - cols:
                - type: fields_table
                  col_lg: 6
                  col_md: 6
                  fields_table: 
                      name: infos
#                      - cols: 
#                          - type: custom
#                            col_lg: 12
#                            custom:
#                                callback: renderChronoView
                - type: fields_table
                  col_lg: 6
                  col_md: 6
                  fields_table:
                      name: objects
            - cols: 
                - type: list
                  list: 
                      children: inters
            - cols: 
                - type: list
                  list: 
                      children: bs_notes
            - cols: 
                - type: list
                  list: 
                      children: files
                      
    client:
        edit_form: edit_ticket_interface
        edit_btn: 1
        rows:
            - cols:
                - type: fields_table
                  
                  # Voir pour boutton modifier en bas
                  col_lg: 12
                  col_md: 12
                  fields_table: 
                      name: client_infos
            - cols:
                - type: list
                  list:
                      children: bs_notes
                      name: client
                
                - type: list
                  list:
                      children: files
    
    client_inters:
        rows:
    
    public_client: 
        panel: 0
        rows:
            - cols: 
                  - type: object_header
            - cols: 
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: public_infos
                  - type: fields_table
                    col_lg: 6
                    col_md: 6
                    fields_table: 
                        name: public_objects
    
filters: 
    id_user_resp: 
        type: user
        input: 
          type: search_user
          include_empty: 1
          empty_label: Aucun

filters_panels:
    default: 
        filters: 
            status:
            priorite:
            impact:
            date_create:
            id_user_resp:
            id_contrat:
            id_client:
            
lists_cols:
    id: 
        label: N°
        min_width: 40
    priorite:
        label: Prio.
        display: icon
        min_width: 40
    impact:
        label: Imp.
        display: icon
        min_width: 40
    sujetCall:
        label: Sujet
        value: 
            callback: displaySujet
    appels_timer: 
        label: Chrono appels
    timer_inters:
        label: Chrono inters
        value:
            callback: displayDureeTotale
    cover: 
        label: Couvert
        display: icon
        min_width: 60
                
lists:
    default: 
        title: Tickets Hotline
        configurable: 1
        checkboxes: 1
        filters_panel: default
        bulk_actions:
            - label: supprimer les tickets sélectionnés
              icon: fas_trash-alt
              onclick: deleteSelectedObjects('list_id', $(this))
        objects_change_reload: BS_Inter
        sort_field: date_create
        sort_way: desc
        n: 10
        add_form_name: default
        add_btn_label: Nouveau ticket hotline
        edit_btn: 1
        edit_form: default
        delete_btn: 1
        page_btn: 1
        modal_view: full
        cols:
            id:
            status:
            priorite:
            impact:
            sujetCall:
            date_create:
            id_user_resp:
            id_contrat:
            id_service:
            id_client:
            timer_inters:
    
    client_admin: 
        extends: default
        cols: 
            client: unset
            
    client: 
        extends: default
        page_btn: 0
        extra_btn:
            callback: getExtraBtnListInterfaceClient
        add_form_values: 
            fields:
                status: 20
        cols:
            id_client: unset
            id_user_resp: unset
                
    public_client: 
        title: Liste des tickets
        icon: fas_bars
        configurable: 0   
        checkboxes: 0
        sort_field: date_create
        sort_way: desc
        n: 10
        edit_btn: 1
        edit_form: public_edit
        extra_btn: 
            callback: getPublicListExtraButtons                            
        cols:
            ticket_number:
            date_create:
            id_user_client: 
            status:
            sujetCall:
            id_user_resp:
            id_contrat:
                
    public_contrat: 
        extends: public_client
        cols: 
            id_contrat: unset
                
cards:
    default:
        title: nom
        fields: 
            num:
                label: N°
                field: ticket_number
            contrat: 
                label: Contrat
                field: id_contrat
                display: nom_url
            client: 
                label: Client
                field: id_client
                display: nom_url
        view_btn: 1
        
    with_sujet: 
        extends: default
        fields: 
            sujet: 
                field: sujet        

views_lists: 
    default:
        objects_change_reload: BS_Ticket
        title: Tickets Hotline
        component_name: default
        component_type: card
        view_btn: 1
        add_btn: 0
        edit_form: default
        item_col_lg: 12
        item_col_md: 12
        item_modal_view: default
        n: 5
        pagination: 1
        
        
searches:
    default: 
        fields_search: 
            - a.ticket_number
            - s.nom
            - a.sujet
            - a.sujetInterne
        fields_return: 
            - a.ticket_number
            - s.nom
            - a.sujet
        label_syntaxe: '<a.ticket_number> (<s.nom> : <a.sujet>)'
        joins: 
            - table: societe
              on: a.id_client = s.rowid
              alias: s
        order_way: desc