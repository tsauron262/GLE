extends: 
    module: bimpcommercial
    object_name: BimpComm

abstract: 0

dol_object: 
    instance: 
        dol_object: commande
            
table: commande
controller: commande
icon: fas_dolly

list_page_url: 
    controller: commandes

labels: 
    name: commande
    is_female: 1
        
objects:
    lines: 
        instance: 
            bimp_object: Bimp_CommandeLine
            
    order_lines: 
        relation: hasMany
        delete: 1
        instance: 
            bimp_object: 
                module: bimpreservation
                name: BR_OrderLine
                
    products: 
        relation: hasMany
        delete: 0
        instance: 
            bimp_object: 
                module: bimpreservation
                name: BR_OrderLine
        list: 
            title: Produits
            filters: 
                type: 1
    
    services: 
        relation: hasMany
        delete: 0
        instance: 
            bimp_object: 
                module: bimpreservation
                name: BR_OrderLine
        list: 
            title: Services
            filters: 
                type: 2
                
    shipment: 
        relation: none
        delete: 0
        instance: 
            bimp_object: 
                module: bimplogistique
                name: BL_CommandeShipment
                
    old_shipments: 
        relation: hasMany
        delete: 1
        instance: 
            bimp_object: 
                module: bimpreservation
                name: BR_CommandeShipment
                
    shipments: 
        relation: hasMany
        delete: 1
        instance: 
            bimp_object: 
                module: bimplogistique
                name: BL_CommandeShipment
                
    fournisseur_price: 
        relation: none
        delete: 0
        instance: 
            bimp_object: 
                module: bimpcore
                name: Bimp_ProductFournisseurPrice
                
    files:
        list: 
            filters:
                parent_object_name: Bimp_Commande
        add_form: 
            values:
                fields: 
                    parent_object_name: Bimp_Commande
                    
    user_resp: 
        extends: user
        instance: 
            id_object: 
                field_value: id_user_resp
                
    client_facture: 
        extends: client
        instance: 
            id_object: 
                field_value: id_client_facture
                
associations: 
    factures: 
        object: facture
        label: Factures
        display: 
            default: 
                type: nom_url
    avoirs: 
        object: facture
        label: Avoirs
        display: 
            default: 
                type: nom_url
                
fields: 
    validComm:
        label: Validation Commerciale
        type: bool
        edit: 0
            
    validFin:
        label: Validation Financiére
        type: bool
        edit: 0
        
    id_facture: 
        label: Facture globale
        type: id_object
        object: facture
        default_value: 0
        
    marge:
        label: Marge
        type: money
        default_value: 0
    
    date_commande:
        label: Date
        type: date
        input: 
            display_now: 1
        required: 1
        
    date_creation: 
        label: Créée le
        type: datetime
        
    date_valid: 
        label: Validée le
        type: datetime
        
    date_cloture: 
        label: Fermée le
        type: datetime
        
    date_prevue_facturation:
        label: Date prévisionnelle de facturation
        type: date
        
#    fk_user_modif: 
#        label: Dernière modification par
#        type: int
        
    fk_user_valid: 
        dol_prop: user_valid
        
#    fk_user_cloture: 
#        label: Fermée par
#        type: int
        
    date_livraison: 
        label: Date prévue de livraison
        type: date
        
    total_ttc: 
        label: Total TTC
        type: money
    
    logistique_status: 
        label: Statut logistique
        type: int
        values: 
            array: logistique_status
        default_value: 0
        
    shipment_status: 
        label: Statut expédition
        type: int
        values: 
            array: shipment_status
        default_value: 0
            
    invoice_status: 
        label: Statut facturation
        type: int
        values: 
            array: invoice_status
        default_value: 0
        
    extra_status: 
        label: Attention particulière
        type: int
        values: 
            array: extra_satus
        default_value: 0
        
    id_user_resp: 
        label: Responsable logistique
        type: id_object
        object: user_resp
        default_value: 0
        input: 
            type: search_user
    
    id_client_facture: 
        label: Client facturation
        type: id_object
        object: client_facture
        default_value: 
            field_value: 0
        input: 
            type: search_societe
            societe_type: customer
            card: default
            help: Laissez vide si même client
            
    status_forced: 
        label: Status forcés
        type: json
        
    revalorisation: 
        label: Demande de revalorisation
        type: int
        values: 
            array: revalorisations
        default_value: 0
        
    pdf_hide_pu: 
        label: Masquer les prix unitaires dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0
        sortable: 0
        
    pdf_hide_reduc: 
        label: Masquer les remises dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0
        sortable: 0
        
    pdf_hide_total: 
        label: Masquer les totaux dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0 
        sortable: 0
        
    pdf_hide_ttc:
        label: Masquer le TTC dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0
        sortable: 0
        
    pdf_periodicity: 
        label: Périodicité
        dol_extra_field: 1
        type: int
        values: 
            array: pdf_periodicities
        default_value: 0
        
    pdf_periods_number: 
        label: Nombre de périodes
        dol_extra_field: 1
        type: qty
        min: 0
        decimals: 0
        default_value: 0
        
    total: unset
        
fields_tables: 
    infos: 
        rows: 
            - field: replaced_ref
              show: 
                  field_value: replaced_ref
            - field: fk_statut
            - field: logistique_status
            - field: shipment_status
            - field: invoice_status
            - field: extra_status
              edit: 1
            - field: entrepot
              display: nom_url
              edit: 1
            - field: ef_type
            - field: fk_input_reason
              edit: 
                  callback: isEditable
            - field: date_commande
              edit: 
                  callback: isEditable
            - field: date_livraison
              edit: 
                  callback: isEditable
            - field: fk_availability
              edit: 
                  callback: isEditable
            - field: validComm
            - field: validFin
            - field: zone_vente
              edit: 1
            - field: revalorisation
              edit: 1
                  
    payment:
        rows:
            - field: fk_cond_reglement
              edit: 
                  callback: isEditable
            - field: fk_mode_reglement
              edit: 
                  callback: isEditable
            - field: date_prevue_facturation
              edit: 1
                  
    client: 
        rows: 
            - field: fk_soc
              display: card
            - field: id_client_facture
              display: card
              show: 
                  field_value: id_client_facture
            - field: ref_client
              edit: 
                  callback: isEditable
            - label: Remises client
              value: 
                  callback: displayRemisesClient
                  
    pdf: 
        rows: 
            - field: pdf_hide_pu
              edit: 1
            - field: pdf_hide_reduc
              edit: 1
            - field: pdf_hide_total
              edit: 1
            - field: pdf_hide_ttc
              edit: 1
            - field: pdf_periodicity
              edit: 1
            - field: pdf_periods_number
              edit: 1
            - label: Fichier PDF
              value: 
                  callback: displayPDFButton
                  
    totals: 
        rows: 
            - label: Remises
              value: 
                  callback: displayTotalRemises
            - field: total_ht
            - field: tva
            - field: total_ttc
                  
views: 
    default: 
        objects_change_reload: Bimp_CommandeLine,ObjectLineRemise,BimpFile,RemiseGlobale
    content_infos: 
        objects_change_reload: Bimp_CommandeLine,ObjectLineRemise,BimpFile,RemiseGlobale
    full: 
        objects_change_reload: Bimp_CommandeLine,ObjectLineRemise,BimpFile,RemiseGlobale
    commandes_fourn: 
        title: Liste des commandes fournisseurs
        icon: fas_cart-arrow-down
        objects_change_reload: Bimp_CommandeLine,BR_Reservation,Bimp_CommandeFournLine
        rows: 
            - cols:
                - type: custom
                  custom:  
                      callback: renderCommandeFournisseursList
    logistique_equipments: 
        rows: 
            - cols: 
                - type: custom
                  custom: 
                      callback: renderLogistiqueEquipmentsView
        
forms: 
    default: 
        on_save: redirect
        msgs:
            callback: getCreateFromOriginCheckMsg
        rows: 
            - field: replaced_ref
            - field: libelle
            - field: entrepot
            - field: ef_type
            - field: fk_soc
            - custom: 1
              label: Afficher forçage création
              input_name: show_force_create
              hidden: 1
              input: 
                  type: hidden
              depends_on: fk_soc
              value: 
                  callback: showForceCreateBySoc
            - custom: 1
              label: Forcer la création
              input_name: force_create_by_soc
              content: 
                  callback: renderForceCreateBySoc
              depends_on: fk_soc
              display_if: 
                  field_name: show_force_create
                  show_values: 1
            - field: id_client_facture
            - field: ref_client
            - field: fk_input_reason
              show: 
                  callback: isEditable
            - field: fk_cond_reglement
            - field: fk_mode_reglement
            - field: date_commande
            - field: date_livraison
            - field: fk_availability
            - field: pdf_hide_pu
            - field: pdf_hide_reduc
            - field: pdf_hide_total
            - field: pdf_hide_ttc
            - field: pdf_periodicity
            - field: pdf_periods_number
            - field: model_pdf
              show: 
                  callback: isNotLoaded
            - field: zone_vente
              show: 
                  callback: isLoaded
            - field: note_private
            - field: note_public
            - custom: 1
              hidden: 1
              label: Elément d'origine
              input_name: origin
              input: 
                  type: hidden
              value: 
                  request_field: origin
            - custom: 1
              hidden: 1
              label: ID élément d'origine
              input_name: origin_id
              input: 
                  type: hidden
              value: 
                  request_field: origin_id
            - custom: 1
              hidden: 1
              input_name: close_propal
              input: 
                  type: hidden
              value: 
                  request: param_values/fields/close_propal

    duplicate:
        rows: 
            date_commande:
                field: date_commande
            date_liv: 
                field: date_livraison
            availability: 
                field: fk_availability
                  
    shipment: 
        title: Expédition
        icon: fas_shipping-fast
        rows: 
            - custom: 1
              label: Expédition
              input_name: id_shipment
              data_type: id_object
              object: shipment
              create_form: default
              create_form_values: 
                  fields: 
                      id_commande_client: 
                          field_value: id_obj
              card: default
              content: 
                  callback: renderShipmentsInput
            - custom: 1
              label: Lignes
              hidden: 1
              input_name: shipment_lines_list
              content: 
                  callback: renderShipmentLinesListInput
            - custom: 1
              label: Quantités et équipements
              input_name: shipment_lines
              content: 
                  callback: renderShipmentLinesInputs
              depends_on: id_shipment,shipment_lines_list
        
    invoice: 
        title: Facturation
        icon: fas_file-invoice-dollar
        rows: 
            - custom: 1
              label: Facture
              input_name: id_facture
              data_type: id_object
              card: default
              content: 
                  callback: renderFacturesInput
              hidden: 
                  request_field: new_facture
            - custom: 1
              label: Référence facture remplacée
              input_name: replaced_ref
              input: 
                  type: text
                  help: Utiliser ce champ si perte des données de la facture remplacée
              display_if: 
                  field_name: id_facture
                  show_values: 0
            - custom: 1
              label: Client
              input_name: id_client_facture
              data_type: id_object
              object: client_facture
              card: default
              input: 
                  type: search_societe
                  societe_type: customer
              display_if: 
                  field_name: id_facture
                  show_values: 0
            - custom: 1
              label: Contact
              input_name: id_contact
              data_type: id
              input: 
                  type: select
                  options: 
                      array: clientFactureContacts
              display_if: 
                  field_name: id_facture
                  show_values: 0
              depends_on: id_client_facture
            - custom: 1
              label: Conditions de règlement
              input_name: id_cond_reglement
              data_type: id
              input: 
                  type: select_cond_reglement
              display_if: 
                  field_name: id_facture
                  show_values: 0
              depends_on: id_client_facture
              value: 
                  callback: getCondReglementBySociete
            - custom: 1
              label: Compte bancaire
              input_name: id_account
              data_type: id_object
              input: 
                  type: select_mysoc_account
              required: 1
              display_if: 
                  field_name: id_facture
                  show_values: 0
              value: 
                  conf: bimpcaisse_id_default_account
            - custom: 1
              label: Avoirs client à utiliser
              input_name: id_remises_list
              input: 
                  multiple: 1
                  type: select_remises
                  id_client:
                      request_field: id_client_facture
              depends_on: id_client_facture
              display_if: 
                  field_name: id_facture
                  show_values: 0
            - custom: 1
              label: Note publique
              input_name: note_public
              data_type: text
              input: 
                  type: textarea
                  rows: 3
                  auto_expand: 1
              display_if: 
                  field_name: id_facture
                  show_values: 0
            - custom: 1
              label: Note privée
              input_name: note_private
              data_type: text
              input: 
                  type: textarea
                  rows: 3
                  auto_expand: 1
              display_if: 
                  field_name: id_facture
                  show_values: 0
            - custom: 1
              label: Lignes
              hidden: 1
              input_name: facture_lines_list
              content: 
                  callback: renderFactureLinesListInput
            - custom: 1
              label: Quantités et équipements
              input_name: facture_lines
              content: 
                  callback: renderFactureLinesInputs
              depends_on: id_facture,facture_lines_list
                  
    shipment_equipments:
        title: Attribution d'équipements à une expédition
        icon: fas_arrow-circle-right
        rows: 
            - custom: 1
              hidden: 1
              label: Réservations sélectionnées
              input_name: reservations
              input: 
                  type: hidden
            - custom: 1
              label: Expédition
              input_name: id_shipment
              data_type: id_object
              required: 1
              object: shipment
              input: 
                  type: select
                  options: 
                      array: shipments
                  card: default
            - custom: 1
              label: Equipements
              input_name: equipments
              content: 
                  callback: renderEquipmentsToAddToShipmentCheckList
              depends_on: id_shipment,reservations
              
    force_status: 
        title: Forcer un statut
        msgs: 
            - content: Lorqu&apos;un statut est forcé, il cesse d&apos;être déterminé automatiquement<br/>Pour annuler un forçage, sélectionnez "Aucun forçage"
              type: info
        rows: 
            - custom: 1
              label: Forcer le statut logistique à
              input_name: logistique_status
              input: 
                  type: select
                  options:
                      -1: Aucun forçage
                      0: A traiter
                      1: En cours de traitement
                      2: Traitée
                      3: Compléte
            - custom: 1
              label: Forcer le statut expédition à
              input_name: shipment_status
              input: 
                  type: select
                  options:
                      -1: Aucun forçage
                      0: Non expédiée
                      1: Expédiée partiellement
                      2: Expédiée
            - custom: 1
              label: Forcer le statut facturation à
              input_name: invoice_status
              input: 
                  type: select
                  options:
                      -1: Aucun forçage
                      0: Non facturée
                      1: Facturée partiellement
                      2: Facturée    
                      
    vignettes: 
        rows: 
            - custom: 1
              label: Nombre de vignettes à générer
              data_type: qty
              input_name: qty
              input: 
                  type: qty
              value: 1
    
filters_panels: 
    default: 
        filters: 
            type: unset
            datec: unset
            total: unset
            id_user_resp: 
            total_ttc: 
            date_creation: 
            logistique_status:
            shipment_status: 
            invoice_status: 
            date_livraison: 
            revalorisation:
            validComm:
            validFin:
            
lists_cols: 
    validComm: 
        label: Valid. comm.
    validFin:
        label: Valid. fin.
#    logistique_status:
#        label: St. log.
#        display: icon
#        min_width: 30
#    shipment_status: 
#        label: St. exp.
#        display: icon
#        min_width: 30
#    invoice_status: 
#        label: St. fac.
#        display: icon
#        min_width: 30
        
lists: 
    default: 
        total_row: 1
        title: Liste des commandes
        icon: fas_dolly
        bulk_actions:
            delete:
                label: supprimer les commandes sélectionnées
            force_paye:
            - label: Forcer facturé les commandes sélectionnées
              icon: fas_trash-alt
              onclick: setSelectedObjectsAction($(this), 'list_id', 'forceStatusMultiple', {'status':'2','type':'invoice_status'}, '', 'Forcer facturé ', true)
            force_expe:
            - label: Forcer expédié les commandes sélectionnées
              icon: fas_trash-alt
              onclick: setSelectedObjectsAction($(this), 'list_id', 'forceStatusMultiple', {'status':'2','type':'shipment_status'}, '', 'Forcer expédié ', true)
        sort_field: date_creation
        sort_way: desc
        add_form_values: 
            fields: 
                entrepot: 
                    request: id_entrepot
                fk_soc:
                    request: id_client
        cols: 
            ref: 
            fk_statut: 
            commercial:
            libelle:
            entrepot: 
            fk_soc:
            date_creation: 
            total_ttc:
    client: 
        extends: default
        cols: 
            fk_soc: unset
            
cards: 
    default: 
        title: 
            field_value: ref
        status: fk_statut
        view_btn: 1
        fields: 
            - field: replaced_ref
            - field: total_ttc
            - field: fk_soc
            - label: Fichier PDF
              value: 
                  callback: displayPDFButton

searches:
    default: 
        fields_search: 
            - a.ref
            - ef.libelle
            - s.nom
            - a.replaced_ref
        joins:
            ef: 
                table: commande_extrafields
                on: a.rowid = ef.fk_object
                alias: ef
            s: 
                table: societe
                on: a.fk_soc = s.rowid
                alias: s
        fields_return: 
            - a.ref
            - s.nom
        label_syntaxe: '<a.ref> (Client: <s.nom>)'

views_lists: 
    default:
        sort_field: date_creation