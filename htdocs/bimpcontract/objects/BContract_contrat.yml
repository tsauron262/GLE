dol_object: 
    instance: 
        dol_object: 
            module: contrat
            file: contrat
            
table: contrat
primary: rowid
controller: contrat
icon: fas_file-signature
list_page_url: 
    controller: index  
header_btn: 
    callback: getActionsButtons
header_edit_form: edit_contrat

labels: 
    name: contrat
                
objects:
    client:
        instance:
            dol_object:
                module: societe
                file: societe
            id_object:
                field_value: fk_soc
    
    lines:
        relation: hasMany
        instance:
            bimp_object: BContract_contratLine
    
    avenant:
        relation: hasMany
        instance:
            bimp_object: BContract_avenant
    
    files:
        relation: hasMany
        delete: 1
        instance:
            bimp_object:
                module: bimpcore
                name: BimpFile
        list: 
            filters:
                parent_module: bimpcontract
                parent_object_name: BContract_contrat
                deleted: 0
        add_form: 
            name: upload
            values:
                fields: 
                    parent_module: bimpcontract
                    parent_object_name: BContract_contrat
        
    echeancier:
        instance:
            bimp_object: BContract_echeancier
    
    user_create:
        instance:
            bimp_object:
                module: bimpcore
                name: Bimp_User
            id_object:
                field_value: fk_user_author
    commercial:
        instance:
            bimp_object:
                module: bimpcore
                name: Bimp_User
            id_object:
                field_value: fk_commercial_suivi
                
    commercial_sign:
        instance:
            bimp_object:
                module: bimpcore
                name: Bimp_User
            id_object:
                field_value: fk_commercial_signature
    
    entrepot: 
        instance: 
            id_object:
                field_value: entrepot
    
    client_facturation:
        instance:
            bimp_object:
                module: bimpcore
                name: Bimp_Societe
            id_object:
                field_value: fk_soc_facturation
    
    fiche_inter:
        instance:
            bimp_object:
                module: bimptechnique
                name: BT_ficheInter

fields:
    # Champs du contrat
    ref: 
        label: Référence
        type: string
    label:
        label: Libellé du contrat
        type: string
    fk_soc:
        label: Client
        type: id_object
        object: client
        dol_prop: socid
        required: 1
        input: 
            type: search_societe
            societe_type: customer
            help: Entrez le nom ou la référence d'un client pour effectuer une recherche
            card: default
        search:
            input: 
                type: search_societe
                societe_type: customer    
        create_form: light
    ref_ext:
        type: string
        label: Annule et remplace
        input:
            help: A remplir en cas de renouvellement d'un ancien contrat - 15 caractères maximum
    ref_customer:
        type: text
        label: Référence client
    datec:
        label: Créé le
        type: date
    date_contrat:
        label: Date de signature
        type: date
    statut:
        label: Statut
        type: int
        values:
            array: status_list
    fk_user_author:
        label: Créé par
        type: id_object
        object: user_create
        dol_prop: user_author_id
        input: 
            type: search_user
    note_public:
        label: Note particulière au contrat
        type: html
    note_private:
        label: Note privée
        type: html
        
    # Extrafields
    date_start:
        label: Date d'effet du contrat
        type: date
        dol_extra_field: 1
        required: 1
    duree_mois:
        label: Durée en mois
        type: qty
        dol_extra_field: 1
        default_value: 12
        required: 1
    periodicity:
        label: Périodicité de facturation
        type: int
        dol_extra_field: 1
        values:
            array: period
    gti:
        label: Delais d'intervention
        type: int
        dol_extra_field: 1
        require: 1
        values:
            array: gti
    syntec:
        label: Indice SYNTEC en vigueur à la signature
        type: float
        dol_extra_field: 1
        default_value: 
            callback: getIndiceSyntec
        input:
            help: 
                callback: getSyntecSite
        display_if:
            field_name: use_syntec
            show_values: 1
    contrat_source:
        label: Contrat Initial
        type: int
        dol_extra_field: 1
    tacite:
        label: Renouvellement
        type: int
        dol_extra_field: 1
        values:
            array: renouvellement
        default_value: 12
    denounce:
        label: Contrat dénoncé
        type: int
        dol_extra_field: 1
        values:
            array: denounce
        default_value: 0
    moderegl:
        label: Mode de règlement
        type: int
        dol_extra_field: 1
        default_value: 
            callback: getModeReglementClient
        values:
            array: modeReglements
    objet_contrat:
        label: Type du contrat
        dol_extra_field: 1
        required: 1
        values:
            array: objet_contrat
    entrepot:
        label: Entrepôt
        dol_extra_field: 1
        type: id_object
        object: entrepot
        input: 
            type: search_entrepot
    end_date_contrat:
        label: Date de fin du contrat
        dol_extra_field: 1
        type: date
    end_date_reel:
        label: Date de fin réelle
        dol_extra_field: 1
        type: date
    anticipate_close_note:
        label: Note de cloture anticipée
        dol_extra_field: 1
        type: string
    fk_soc_facturation:
        label: Client pour facturation
        type: id_object
        object: client_facturation
        input:
            type: search_societe  
    fk_commercial_signature:
        label: Commercial signataire
        dol_prop: commercial_signature_id
        type: id_object
        object: commercial_sign
        input: 
            type: search_user
            help: Choisir le commercial responssable de la signature du contrat
            card: default 
        default_value: 
           prop:
               name: id
               object:
                   global: user
    fk_commercial_suivi:
        label: Commercial suivi
        dol_prop: commercial_suivi_id
        type: id_object
        object: commercial
        input: 
            type: search_user
            help: Choisir le commercial responssable du suivi du contrat
            card: default 
        default_value: 
           prop:
               name: id
               object:
                   global: user
    date_cloture:
        label: Clos le
        type: datetime
    fk_user_cloture:
        label: Clos par
        type: int
    logs:
        label: Logs contrat
        type: text
    relance_renouvellement:
        label: Relance Email pour renouvellement du contrat
        type: bool
    facturation_echu:
        label: Facturation à terme échu
        type: bool
        input:
            type: toggle
    secteur:
        label: Secteur
        type: string
        values:
            array:
                callback: getSecteursContrat
    
fields_tables:
    infos:
        panel: 0
        rows:
            - field: label
              edit: 0
            - field: secteur
              edit: 0
            - field: ref
              label: Référence du contrat
              edit: 0
            - field: ref_ext
              edit: 0
            - field: ref_customer
              edit: 0
            - field: objet_contrat
              edit: 0
            - field: entrepot
              display: nom_url
              show:
                  callback: useEntrepot
            - label: Contrat initial
              value:
                  callback: displayContratSource
            - label: Contrat de remplacement 
              value:
                  callback: displayContratChild
            - field: date_start
              edit: 0
            - label: Date de début de prochaine période de facturation
              value:
                  callback: displayDateNextFacture
            - field: duree_mois
              edit: 0
            - label: Date de fin du contrat
              value: 
                  callback:
                      method: displayEndDate
                      params:
                          - value:
                              callback:
                                  method: getData
                                  params:
                                      - date_start
                          - value:
                              callback:
                                  method: getData
                                  params:
                                      - duree_mois
            - field: periodicity
              edit: 0
            - field: facturation_echu
            - field: moderegl
              edit: 0
            - field: gti
              edit: 0
            - field: syntec
              edit: 0
            - field: tacite
              edit: 0
            - field: denounce
              edit: 0
            - field: fk_commercial_suivi
              display: nom_url
            - field: fk_commercial_signature
              display: nom_url
            - field: relance_renouvellement
              edit: 0
            - label: Rentabilitée
              value:
                  callback: renderThisStatsFi
    client: 
        panel: 0
        rows: 
            - field: fk_soc
              display: card
            - field: fk_soc_facturation
              display: card
            - field: note_public
            - field: note_private
            - field: logs
          
filters: 
    commercialclient:
        label: Commercial client
        input:
            type: search_user
        data_type: id_object
        type: user

    use_syntec:
        label: Utilisation Syntec
        type: check_list
        items:
          1: OUI
          0: NON
        exclude_btn: 0
                
    reconduction:
        label: Recondution
        type: check_list
        items:
            0: Aucune
            1: Sur proposition
            2: Tacite
            
filters_panels: 
    default: 
        filters:
            ref:
                show: 1
            statut:
            commercial:
            client:
            commercialclient:
            entrepot:
            end_date_contrat:
            datec:
            syntec:
            use_syntec:
            reconduction:
                    
            have_fi:
                field: have_fi
                custom: 1
                label: Fiches d'interventions liées
                type: check_list
                items:
                    1: OUI
                    0: NON
                exclude_btn: 0
                show:
                    callback:
                        method: isActive
                        object: fiche_inter
                        is_static: 1

lists_cols: 
    signed:
        label: Contrat signé
        value:
            callback:
                method: isSigned
                params:
                    - display
                          
    date_fin:
        label: Date de fin du contrat
        value: 
            callback:
                method: displayEndDate
                
    commercialclient:
        label: Commercial Client
        value:
            callback: displayCommercialClient
        search:
            input: 
                type: search_user

lists: 
    default:
        title: Contrat
        configurable: 1
        checkboxes: 1
        icon: fas_file-contract
        filters_panel: default
        bulk_actions:
            callback: getBulkActions
        sort_field: datec
        sort_way: desc
        n: 20
#        add_form_name: add_contrat
#        add_btn_label: Créer un nouveau contrat
        edit_btn: 1
        edit_form: edit_contrat
        delete_btn: 0
        modal_view: fiche_contrat
        page_btn: 1
        cols: 
            ref: 
            signed:
            datec:
            statut:
            entrepot:
            fk_soc:
            date_start:
#            date_fin:
            end_date_contrat:
            fk_user_author:
            fk_commercial_suivi:
            fk_commercial_signature:
            commercialclient:

    client:
        extends: default
        n: 10
        cols:
            fk_soc: unset

forms:
    renew_tacite:
        title: Créer un renouvellement
        msgs:
            - content: Merci de confirmer le renouvellement du contrat. Si des champs s'affichent dans ce formulaire, merci de les renseigner correctement
        rows:
            - custom: 1
              label: Date d'effet du renouvellement
              input_name: date_effet
              input:
                  type: date
                  display_now: 1
              show:
                  callback: isConformWithDate
    planningInter:
        title: Plannifier une intervention
        icon: calendar
        msgs:
            - content:
                callback: getMsgsPlanningFi
        rows:
            - custom: 1
              label: Intervention urgente
              input_name: urgent
              value: 0
              input:
                  type: toggle
            - custom: 1
              label: Techniciens
              input_name: techs
              content:
                  callback: renderTechsInput
            - custom: 1
              label: Le
              required: 1
              input_name: le
              input:
                  type: date
            - custom: 1
              label: De
              input_name: de
              required: 1
              input:
                  help: Les secondes ne serons pas pris en compte
                  type: time
            - custom: 1
              label: A
              input_name: a
              required: 1
              input:
                  help: Les secondes ne serons pas pris en compte
                  type: time
            - custom: 1
              label: Type de plannification
              required: 1
              input_name: type_planning
              input:
                  type: select
              values:
                  callback: getTypeActionCommArray
            - custom: 1
              label: Actions à faires ?
              input_name: description
              input:
                  type: html
            - custom: 1
              label: Lier une ou plusieurs commandes
              input_name: linked_commandes
              data_type: id_object
              input: 
                  type: check_list
                  items: 
                      callback: getCommandesClientArray
            - custom: 1
              label: Lier un ou plusieurs tickets support
              input_name: linked_tickets
              data_type: id_object
              input:
                  type: check_list
                  items:
                      callback: getTicketsSupportClientArray
    old_to_new:
        title: Ancienne vers Nouvelle version
        msgs:
            - content: Merci de vérifier et de corriger les informations si nécéssaire, ceci est une action définitive.
        rows:
            - custom: 1
              label: Date début du contrat
              input_name: date_start
              value: 
                    callback: getStartDateForOldToNew
              input:
                  type: date
            - custom: 1
              label: Durée en mois
              input_name: duree
              value:
                  callback: getDureeForOldToNew
              input:
                  type: qty
            - custom: 1
              label: Périodicitée
              input_name: periode
              value: 3
              values:
                  array: period
              input:
                  type: select
            - custom: 1
              label: Date prochaine facture
              required: 1
              input_name: date_facture_date
              input:
                  type: date
              value:
                  callback: getNextDateFactureOldToNew
            - custom: 1
              label: Contrat totalement facturé
              input_name: total
              input:
                  type: toggle
              value: 0
              help: Si oui, aucun échéancier ne sera créé
              

    demande_intervention:
        title: Créer une demande d'intervention
        rows:
            - custom: 1
              label: Date d'intervention (Indicative)
              input_name: date
              data_type: date
              required: 1
              input:
                  type: date
                  display_now: 1
            - custom: 1
              label: Durée de l'intervention
              input_name: duree
              required: 1
              input:
                  type: timer
            - custom: 1
              label: Titre
              input_name: titre
              data_type: text
              input:
                  type: text
            - custom: 1
              label: Intervenant
              required: 1
              input_name: tech
              value:
                    prop:
                        name: id
                        object:
                            global: user
              input:
                  type: search_user
            - custom: 1
              label: Intervenants supplémentaires
              input_name: techs
              content:
                  callback: renderTechsInput
            - custom: 1
              label: Lignes du contrat
              input_name: lines
              data_type: id_object
              input: 
                  help: Les lignes cochées apparaîtrons dans la DI
                  type: check_list
                  items: 
                      callback: getLinesContrat
              
    fiche_inter:
        rows:
            - custom: 1
              label: Date prévu d'intervention
              input_name: date
              date_type: date
              required: 1
              input:
                  type: date
            - custom: 1
              label: Intervention urgente
              value: 0
              input_name: urgent
              input:
                  type: toggle
            - custom: 1
              label: Intervenant principal
              input_name: fk_user_author
              value:
                    prop:
                        name: id
                        object:
                            global: user
              input:
                  type: search_user
                  
            - custom: 1
              label: Intervenants supplémentaires
              input_name: techs
              content:
                  callback: renderTechsInput
            - custom: 1
              label: Type d'intervention
              input_name: type_inter
              value: 3
              input:
                  type: select
                  options:
                      prop:
                          object: fiche_inter
                          name: type_list
                          is_static: 1
            - custom: 1
              label: Nature de l'intervention
              input_name: nature_inter
              value: 1
              input:
                  type: select
                  options:
                      prop:
                          object: fiche_inter
                          name: nature_list
                          is_static: 1
            - custom: 1
              label: Note public
              input_name: public
              input:
                  type: html
            - custom: 1
              input_name: private
              label: Note privé
              input:
                  type: html
    addAcc:
        title: Ajouter un acompte
        rows:
            - custom: 1
              label: Acompte sur compte client
              input_name: acc
              input:
                  type: select
                  options:
                        callback: getAcomptesClient
    
    anticipate:
        force_edit: 1
        msgs:
            - content: Quelques informations sont nécéssaires pour anticiper la fermeture de ce contrat
              type: warning
        rows:
            - custom: 1
              input_name: end_date_reel
              required: 1
              label: Date de fin effective du contrat
              input:
                  type: date
            - custom: 1
              label: Cause de cloture anticipée du contrat
              input_name: note_close
              input:
                  type: html
            
    email: 
        rows: 
            - custom: 1
              label: Emetteur
              input_name: from
              input: 
                  type: select
                  options: 
                      array: emailUsersFrom
                      
            - custom: 1
              label: Destinataires
              input_name: mail_to
              input: 
                  type: custom
                  content: 
                      callback: 
                          method: renderMailToInputs
                          params: 
                              - mail_to
                  multiple: 1
              values: 
                  array: mailsTo
              value: 
                  callback: getDefaultMailTo
              required: 1
              
            - custom: 1
              label: Copies à
              input_name: copy_to
              input: 
                  type: custom
                  content: 
                      callback: 
                          method: renderMailToInputs
                          params: 
                              - copy_to
                  multiple: 1
                          
            - custom: 1
              label: Accusé de réception
              input_name: confirm_reception
              data_type: bool
              input: 
                  type: toggle
              default_value: 0
              
            - custom: 1
              label: Modèle de courriel
              input_name: id_model
              input: 
                  type: select
                  options: 
                      array: emailModels
                      
            - custom: 1
              label: Objet
              input_name: mail_object
              input: 
                  type: text
              value: 
                  callback: getEmailTopicByModel
              depends_on: id_model
              
            - custom: 1
              label: Message
              data_type: html
              input_name: msg_html
              input: 
                  type: html
              value: 
                  callback: getEmailContentByModel
              depends_on: id_model
              
            - custom: 1
              label: Fichiers joints
              input_name: join_files
              data_type: id_object
              input: 
                  type: check_list
                  items: 
                      callback: getAllFiles
#                      array: files
              value: 
                  callback: getJoinFilesValues
              object: files
              create_form: upload
              create_form_label: Ajouter
              create_form_values: 
                  fields: 
                      parent_module: 
                          prop: module
                      parent_object_name: 
                          prop: object_name
                      id_parent: 
                          prop: id
                          
    edit_contrat:
        rows:
            - field: label
            - field: ref
              edit: 0
            - field: ref_ext
            - field: ref_customer
            - field: objet_contrat
            - field: entrepot
            - field: fk_soc
              edit: 0
            - field: fk_soc_facturation
            - field: date_start
            - field: duree_mois
            - field: periodicity
            - field: facturation_echu
            - field: moderegl
            - field: gti
            - field: syntec
            - field: fk_commercial_suivi
            - field: fk_commercial_signature
            - field: tacite
            - field: denounce
            - field: note_public
            - field: note_private
            - field: relance_renouvellement
              edit:
                  callback: isCommercialOfContrat
    
    add_contrat:
        rows:
            - field: datec
              edit: 0
              show: 0
            - field: objet_contrat
#            - custom: 1
#              label: Site du contrat
#              input_name: site_contrat
#              input:
#                  type: text
#              required: 1
            - field: fk_soc
            - field: date_start
            - field: duree_mois
            - field: periodicity
            - field: gti
            - field: tacite
            - custom: 1
              label: Utiliser l'indice SYNTEC
              value: 1
              input_name: use_syntec
              input: 
                  type: toggle
                  
            - field: syntec
                  
            - field: denounce
              edit: 0
            - field: moderegl
            - field: fk_commercial_signature
            - field: fk_commercial_suivi
    
    add_linked_object:
        force_edit: 1
        rows:
            - custom: 1
              label: Type de pièce
              input_name: type_piece
              input: 
                type: select
              values: 
                array: true_objects_for_link
            - custom: 1
              label: Liste des commandes client
              input_name: commande_client
              input: 
                  type: select
              values:
                   callback: 
                       method: getListClient
                       params:
                           - commande
              display_if:
                  field_name: type_piece
                  show_values: commande
            - custom: 1
              label: Liste des factures fournisseur client
              input_name: facture_fourn_client
              input: 
                  type: select
              values:
                   callback: 
                       method: getListClient
                       params:
                           - facture_fourn
              display_if:
                  field_name: type_piece
                  show_values: facture_fourn
#            - custom: 1
#              label: Liste des propositions commercial client
#              input_name: propal_client
#              input: 
#                  type: select
#              values:
#                   callback: 
#                       method: getListClient
#                       params:
#                           - propal
#              display_if:
#                  field_name: type_piece
#                  show_values: propal
    clone_contrat:
        edit: 1
        msgs:
            - content: <h4>Merci de confirmer le clone du contrat</h4>
              type: warning
              
    contact:
        title: Ajouter un contact
        rows: 
            - custom: 1
              label: Type
              input_name: type
              input: 
                  type: select
                  options: 
                      1: Contact tiers
                      2: Utilisateur
            - custom: 1
              label: Tiers
              input_name: id_client
              input: 
                  type: search_societe
                  societe_type: customer
              value: 
                  field_value: fk_soc
              display_if: 
                  field_name: type
                  show_values: 1
            - custom: 1
              label: Contact
              input_name: id_contact
              data_type: id_object
              object: contact
              create_form: default
              create_form_values:
                  fields: 
                      fk_soc: 
                          callback: getAddContactIdClient
              value: 
                  request: fields/id_contact
              input: 
                  type: select
                  options: 
                      array: clientContacts
              display_if: 
                  field_name: type
                  show_values: 1
              depends_on: id_client
            - custom: 1
              label: Utilisateur
              input_name: id_user
              input: 
                  type: search_user
              value: 
                  prop:
                      object: 
                          global: user
                      name: id
              display_if: 
                  field_name: type
                  show_values: 2
            - custom: 1
              label: Type de contact
              input_name: tiers_type_contact
              input: 
                  type: select
                  options: 
                      array: externalContactTypes
              display_if: 
                  field_name: type
                  show_values: 1
            - custom: 1
              label: Type de contact
              input_name: user_type_contact
              input: 
                  type: select
                  options: 
                      array: internalContactTypes
              display_if: 
                  field_name: type
                  show_values: 2 
                  
views:
    # La vue "default" est obligatoire. 
    default:
        extends: fiche_contrat 
        
    fiche_contrat:
        objects_change_reload: BContract_echeancier, BContract_contrat
        title:
            callback: displayRef
        objects_change_reload: BContract_contract
        delete_btn: 1
        edit_form: edit_contrat
        footer_extra_btn: 
            callback: getActionsButtons
        rows:
            - cols: 
                - type: rows
                  col_lg: 6
                  col_md: 6
                  rows:                        
                      - cols: 
                          - type: fields_table
                            col_lg: 12
                            fields_table: 
                                name: infos
                - type: rows
                  col_lg: 6
                  col_md: 6
                  rows:
                      - cols:
                          - type: fields_table
                            col_lg: 12
                            fields_table:
                                name: client
            - cols: 
                - type: custom
                  col_lg: 6
                  col_md: 6
                  col_sm: 12
                  custom:
                      callback:
                            method: renderLinkedObjectsTable

                - type: custom
                  col_lg: 6
                  col_md: 6
                  col_sm: 12
                  custom: 
                    callback:
                        method: renderFilesTable
            - cols:
                - type: custom
                  custom: 
                      callback: 
                          method: renderNotesList
                          params:
                              - 1
            - cols:
                - type: list
                  show: 
                      callback:
                          method: isActive
                          object: fiche_inter
                          is_static: 1
                  list: 
                      name: default
                      object: fiche_inter
                      
    interface_client:
        title:
            callback: displayRef
        show: 
            callback: canClientViewDetail
        objects_change_reload: BContract_contract
        delete_btn: 1
        edit_form: edit_contrat
        footer_extra_btn: 
            callback: getActionsButtons
        rows:
            - cols: 
                - type: rows
                  col_lg: 12
                  col_md: 12
                  rows:                        
                      - cols: 
                          - type: fields_table
                            col_lg: 12
                            fields_table: 
                                name: infos
                      - cols:
                          - type: list
                            col_lg: 12
                            list:
                                object: lines
                                name: interface_client

    file:
        title: Fichiers joint
        rows:
            - cols: 
                - type: rows
                  col_md: 12
                  col_lg: 12
                  rows:
                      - cols:
                          - type: list
                            list: 
                               children: files
                               
    echeancier:
        objects_change_reload: BContract_echeancier, BContract_contrat
        title:
            callback: getTitleEcheancier
        panel: 1
        rows:
            - cols:
                - type: custom
                  col_lg: 18
                  col_md: 12
                  custom:
                      callback: renderEcheancier
    
    avenant:
        objects_change_reload: BContract_echeancier, BContract_contrat
        title: Avenants du contrat
        panel: 1
        rows:
            - cols:
                - type: list
                  col_lg: 18
                  col_md: 12
                  list:
                      children: avenant
                      
    lines:
        objects_change_reload: BContract_echeancier, BContract_contrat
        title: Contenu du contrat
        panel: 0
        rows:
            - cols:
                - type: list
                  list:
                      children: lines

searches:
    default:
        fields_search: 
            - a.ref
            - s.nom
#            - ef.objet_contrat
        joins:
#            ef: 
#                table: contrat_extrafields
#                on: a.rowid = ef.fk_object
#                alias: ef
            s: 
                table: societe
                on: a.fk_soc = s.rowid
                alias: s
        fields_return: 
            - a.ref
            - s.nom
#            - ef.objet_contrat
#        label_syntaxe: '<a.ref> (<s.nom>) - <ef.objet_contrat>'
        label_syntaxe: '<a.ref> (<s.nom>)'

cards:
    default:
        title: 
            field_value: ref
        status: statut
        fields: 
            - field: objet_contrat
            - field: fk_soc
              display: nom_url
            - field: date_start
            - field: end_date_contrat
        view_btn: 1
