extends: 
    module: bimpcommercial
    object_name: BimpComm
    
dol_object: 
    instance: 
        dol_object: 
            module: compta/facture
            file: facture
            
force_extrafields_update: 1

table: facture
controller: facture
icon: fas_file-invoice-dollar
list_page_url: 
    controller: factures

labels: 
    name: facture
    is_female: 1
    
objects: 
    lines: 
        instance: 
            bimp_object: Bimp_FactureLine
            
    entrepot: 
        instance: 
            id_object:
                field_value: entrepot
                
    account: 
        instance:
            id_object: 
                field_value: fk_account
    
    files:
        list: 
            filters:
                parent_object_name: Bimp_Facture
        add_form: 
            values:
                fields: 
                    parent_object_name: Bimp_Facture
                    
    user_commission: 
        extends: commission
        instance: 
            id_object: 
                field_value: id_user_commission
                
    entrepot_commission: 
        extends: commission
        instance: 
            id_object: 
                field_value: id_entrepot_commission
                    
fields: 
    facnumber: 
        label: Référence
        dol_prop: ref
    exported:
        label: Comptabilisée
        type: int
    type: 
        label: Type
        type: int
        values: 
            array: types
        input: 
            type: select
            options: 
                array: selectTypes
        depends_on: fk_soc
    model_pdf: 
        default_value: bimpfact
    datec: 
        label: Créée le
        type: datetime
    datef: 
        label: Date facturation
        dol_prop: date
        type: date
        input: 
            display_now: 1
        required: 1
    date_lim_reglement:
        label: Date limite de réglement
        type: date
    fk_account: 
        label: Compte bancaire
        type: id_object
        object: account
        input: 
            type: select_mysoc_account
    centre: 
        label: Centre
        dol_extra_field: 1
        values: 
            array: centres
        display_if: 
            field_name: ef_type
            show_values: S
        default_value: ''
    total: 
        label: Total HT
        dol_prop: total_ht
        type: money
    total_ttc: 
        label: Total TTC
        type: money
    fk_user_author: 
        dol_prop: user_author
    fk_user_valid: 
        dol_prop: user_valid
    paye: 
        label: Paye
        type: bool
        default_value: 0
    pdf_hide_pu: 
        label: Masquer les prix unitaires dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0
        sortable: 0
    pdf_hide_reduc: 
        label: Masquer les remises dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0
        sortable: 0
    pdf_hide_total: 
        label: Masquer les totaux dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0 
        sortable: 0
    pdf_hide_ttc:
        label: Masquer le TTC dans le PDF
        dol_extra_field: 1
        type: bool
        default_value: 0
        sortable: 0
    marge: 
        label: Marge
        type: money
        default_value: 0
    id_user_commission: 
        label: Commission utilisateur
        type: id_object
        object: user_commission
        default_value: 0
    id_entrepot_commission: 
        label: Commission entrepôt
        type: id_object
        object: entrepot_commission
        default_value: 0
    ref: unset
    fk_availability: unset
    fk_input_reason: unset
    total_ht: unset
       
forms:     
    default: 
        msgs: 
            callback: renderCreateWarning
        rows:
            origin: 
                custom: 1
                lable: Origine
                input_name: origin
                input: 
                    type: hidden
                value: 
                    request_field: origin
                hidden: 1
            origin_id: 
                custom: 1
                lable: Origine
                input_name: origin_id
                data_type: int
                input: 
                    type: hidden
                value: 
                    request_field: origin_id
                hidden: 1
            soc: 
                field: fk_soc
            ref_client: 
                field: ref_client
            type: 
                field: type
                show: 
                    callback: isNotLoaded
            typedeposit: 
                custom: 1
                label: Type d'acompte
                input_name: typedeposit
                input: 
                    type: select
                    options: 
                        array: typesDeposit
                display_if:
                    fields_names: type,origin
                    type: 
                        hide_values: 1,2,4,5
                    origin: 
                        show_values: propal,commande
                show: 
                    callback: isNotLoaded
            id_facture_replaced: 
                custom: 1
                label: Facture remplacée
                input_name: id_facture_replaced
                data_type: int
                input: 
                    type: select
                    options: 
                        array: replacedInvoices
                value: 
                    callback: getRequestIdFactureReplaced
                display_if: 
                    field_name: type
                    show_values: 1
                show: 
                    callback: isNotLoaded
                depends_on: fk_soc
            id_facture_to_correct: 
                custom: 1
                label: Facture à corriger
                input_name: id_facture_to_correct
                data_type: int
                input: 
                    type: select
                    options: 
                        array: FacturesToCorrect
                value: 
                    callback: getRequestIdFactureToCorrect
                display_if: 
                    field_name: type
                    show_values: 2
                depends_on: fk_soc
                show: 
                    callback: isNotLoaded
            avoir_same_lines: 
                custom: 1
                label: Créer l'avoir avec les même lignes que la factures dont il est issu
                data_type: bool
                input: 
                    type: toggle
                value: 1
                input_name: avoir_same_lines
                display_if: 
                    fields_names: type,id_facture_to_correct
                    type: 
                        show_values: 2
                    id_facture_to_correct:
                        hide_values: 0
                show: 
                    callback: isNotLoaded
            avoir_remain_to_pay: 
                custom: 1
                label: Créer l'avoir avec le montant restant à payer de la facture dont il est issu.
                data_type: bool
                input: 
                    type: toggle
                value: 0
                input_name: avoir_remain_to_pay
                display_if: 
                    fields_names: type,id_facture_to_correct
                    type: 
                        show_values: 2
                    id_facture_to_correct:
                        hide_values: 0
                show: 
                    callback: isNotLoaded
            ef_type: 
                field: ef_type
            entrepot: 
                field: entrepot
                show: 
                    callback: isEditable
            centre: 
                field: centre
                show: 
                    callback: isEditable
            libelle: 
                field: libelle
            datef: 
                field: datef
                show: 
                    callback: isEditable
            cond_reglement: 
                field: fk_cond_reglement
                show: 
                    callback: isEditable
            mode_reglement: 
                field: fk_mode_reglement
                show: 
                    callback: isEditable
            date_lim_reglement: 
                field: date_lim_reglement
            account: 
                field: fk_account
                show: 
                    callback: isEditable
            pdf_hide_pu: 
                field: pdf_hide_pu 
            pdf_hide_reduc: 
                field: pdf_hide_reduc
            pdf_hide_total: 
                field: pdf_hide_total
            pdf_hide_ttc: 
                field: pdf_hide_ttc
            model_pdf: 
                field: model_pdf
                show: 
                    callback: isNotLoaded
            zone_vente: 
                field: zone_vente
                show: 
                    callback: isLoaded
            remise_globale_label: 
                field: remise_globale_label
                show: 
                    callback: hasRemiseGlobale
            note_private: 
                field: note_private
            note_public: 
                field: note_public
            
    refacture: 
        extends: default
        msgs: unset
        rows: 
            type: 
                field: unset
                show: unset
                label: Type
                custom: 1
                hidden: 1
                input_name: type
                data_type: int
                input: 
                    type: hidden
                value: 0
                
            id_avoir_to_refacture: 
                custom: 1
                hidden: 1
                label: Avoir à refacturer
                input_name: id_avoir_to_refacture
                data_type: id
                input: 
                    type: hidden
                
            typedeposit: unset
            id_facture_replaced: unset
            id_facture_to_correct: unset
            avoir_same_lines: unset
            avoir_remain_to_pay: unset
            typedeposit: unset
            typedeposit: unset
            
    paid_partially:
        msgs: 
            - content: Cette facture n'a pas été payée à hauteur du montant initial. Pour quelle raison voulez-vous la classer malgré tout?
              type: warning
        rows: 
            - custom: 1
              label: Raison
              input_name: close_code
              input: 
                  type: select
                  options: 
                      array: closeReasons
            - custom: 1
              label: Commentaires
              input_name: close_note
              input: 
                  type: textarea
                  rows: 3
                  auto_expand: 1
                  
    cancel:
        msgs: 
            - content: Pour quelle raison voulez-vous classer la facture abandonnée ?
              type: warning
        rows: 
            - custom: 1
              label: Raison
              input_name: close_code
              input: 
                  type: select
                  options: 
                      array: cancelReasons
            - custom: 1
              label: Commentaires
              input_name: close_note
              input: 
                  type: textarea
                  rows: 3
                  auto_expand: 1
                  
    duplicate:
        rows: 
            2: 
                field: libelle
            3: 
                field: ef_type
            4:
                field: date_lim_reglement
            5: 
                field: datef
            6:
                field: fk_account
            7:
                field: fk_cond_reglement
                
    validate: 
        title: Validation
        rows: 
            - custom: 1
              label: Informations
              input_name: validation_type
              content: 
                  callback: renderValidationFormInfos
            - custom: 1
              label: Déplacer les lignes négatives dans un avoir
              input_name: create_avoir
              data_type: bool
              input: 
                  type: toggle
              value: 1
              display_if: 
                  field_name: validation_type
                  show_values: 2
            - custom: 1
              label: Convertir l'avoir en remise
              input_name: convert_avoir_to_reduc
              data_type: bool
              input: 
                  type: toggle
              value: 1
              display_if: 
                  fields_names: validation_type,create_avoir
                  validation_type: 
                      show_values: 1,2
                  create_avoir: 
                      hide_values: 0
            - custom: 1
              label: Appliquer la remise à la facture
              input_name: use_discount_in_facture
              data_type: bool
              input: 
                  type: toggle
              value: 1
              display_if: 
                  fields_names: validation_type,convert_avoir_to_reduc,create_avoir
                  validation_type: 
                      show_values: 1,2
                  convert_avoir_to_reduc: 
                      hide_values: 0
                  create_avoir: 
                      hide_values: 0
            - custom: 1
              hidden: 1
              input_name: hide_force_validation
              data_type: bool
              input: 
                  type: hidden
              value: 
                  callback: checkEquipmentsAttribution
            - custom: 1
              label: Forcer la validation
              input_name: force_validate
              content: 
                  callback: renderForceValidationInput
              display_if: 
                  field_name: hide_force_validation
                  hide_values: 1
                  
    add_to_commission: 
        title: Ajout à une commission
        rows: 
            - custom: 1
              label: Commission
              input_name: id_commission
              data_typel: id
              input: 
                  type: select
                  options: 
                      array: draftCommissions
                                    
fields_tables: 
    infos: 
        rows: 
            - label: Type
              value: 
                  callback: displayType
            - field: libelle
              edit: 1
            - field: fk_statut
            - field: centre
            - field: entrepot
              display: nom_url
            - field: ef_type
              edit: 
                  callback: isEditable
            - field: datef
              edit: 
                  callback: isEditable
            - field: zone_vente
              edit: 1
            - label: Commercial
              value: 
                  callback: displayCommercial
            - field: id_user_commission
              display: nom_url
              show: 
                  callback: showUserCommission
            - field: id_entrepot_commission
              display: nom_url
              show: 
                  callback: showEntrepotCommission
    
    client: 
        rows: 
            - field: fk_soc
              display: card
            - field: ref_client
              edit: 1
            - label: Remises client
              value: 
                  callback: displayRemisesClient
            
    payment:
        rows:
            - field: fk_account    
              edit: 1
            - field: fk_cond_reglement
              edit: 
                  callback: isEditable
            - field: fk_mode_reglement
              edit: 
                  callback: isEditable
            - field: date_lim_reglement
                
    pdf: 
        rows: 
            - field: pdf_hide_pu
              edit: 1
            - field: pdf_hide_reduc
              edit: 1
            - field: pdf_hide_total
              edit: 1
            - field: pdf_hide_ttc
              edit: 1
            - field: remise_globale_label
              edit: 1
              show: 
                  callback: hasRemiseGlobale
            - label: Fichier PDF
              value: 
                  callback: displayPDFButton
                                                 
    totals: 
        rows: 
            - label: Remises
              value: 
                  callback: displayTotalRemises
            - field: total
            - field: tva
            - field: total_ttc
            
views: 
    default: 
        objects_change_reload: Bimp_FactureLine,Bimp_Paiement,ObjectLineRemise,BimpFile,BimpRevalorisation
    content_infos: 
        objects_change_reload: Bimp_FactureLine,Bimp_Paiement,ObjectLineRemise,BimpFile,BimpRevalorisation
    full: 
        objects_change_reload: Bimp_FactureLine,Bimp_Paiement,ObjectLineRemise,BimpFile,BimpRevalorisation
        
filters_panels: 
    default: 
        filters: 
            paye: 
                field: paye
                show: 1
            date_lim_reglement:
                field: date_lim_reglement
            ref: 
                field: facnumber
            total_ht:
                field: total
            total_ttc: 
                field: total_ttc
                
            availability: unset
            
lists_cols: 
    ref: 
        field: facnumber
    type: 
        field: type
    centre: 
        field: centre
    paid: 
        label: Payée
        value: 
            callback: 
                method: displayPaidStatus
                params: 
                    - 0
                    - 1
    date_lim_reglement:
        field: date_lim_reglement
    total_ht: 
        field: total
        has_total: 1
    total_ttc: 
        has_total: 1
        field: total_ttc
    pdf: 
        label: Fichier PDF
        value: 
            callback: 
                method: displayPDFButton
                params: 
                    - false
        available_csv: 0
    datec: 
        field: datec
    availability: unset
    input_reason: unset
    marge:
        field: marge
        has_total: 1
    secteur_comm_check: 
        label: Secteur
        value: 
            callback: displaySecteurWithCommercialCheck     
    remain_to_pay: 
        label: Reste à payer
        value: 
            callback: displayRemainToPay
    
lists: 
    default: 
        total_row: 1
        title: Factures
        icon: fas_file-invoice-dollar
        bulk_actions: unset
        sort_field: datec
        sort_way: desc
        add_btn_label: Créer une nouvelle facture
        add_form_values: 
            fields: 
                entrepot: 
                    request: id_entrepot
                fk_soc:
                    request: id_client
        delete_btn: 0
        cols: 
            ref: 
            type: 
            statut: 
            paid: 
            soc: 
            commercial:
            total_ttc: 
            pdf:
        
    client: 
        extends: default
        cols: 
            soc: unset
            
    commission: 
        total_row: 1
        enable_search: 0
        position: 0
        configurable: 1
        pagination: 1
        n: 20
        sort_field: datec
        sort_way: asc
        extra_btn: 
            callback:
                method: getCommissionListButtons
        modal_view: full
        page_btn: 1
        cols: 
            ref: 
            type: 
            date_valid:
            commercial:
            secteur_comm_check:
            statut: 
            paid: 
            total_ht: 
            total_pa:
            marge: 
            
    user_commission: 
        extends: commission
        extra_btn: 
            callback: 
                params: 
                    - 1

    entrepot_commission: 
        extends: commission
        extra_btn: 
            callback: 
                params: 
                    - 2
            
cards: 
    default: 
        title: 
            field_value: facnumber
        status: fk_statut
        view_btn: 1
        fields: 
            - field: total_ttc
            - label: Payé
              value: 
                  callback: displayPaid
            - label: Fichier PDF
              value: 
                  callback: displayPDFButton
                  
    light: 
        title: 
            field_value: facnumber
        view_btn: 0
        fields: 
            - field: total_ttc
            - field: fk_statut
            - label: Payé
              value: 
                  callback: displayPaid
        
searches:
    default: 
        fields_search: 
            - facnumber
